<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-142508059-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>爱登堡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="此堡非彼堡">
<meta property="og:type" content="website">
<meta property="og:title" content="爱登堡">
<meta property="og:url" content="https://adeng-wc.github.io/index.html">
<meta property="og:site_name" content="爱登堡">
<meta property="og:description" content="此堡非彼堡">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Weng Cheng">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="爱登堡" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">爱登堡</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://adeng-wc.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-理解比特币" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/24/%E7%90%86%E8%A7%A3%E6%AF%94%E7%89%B9%E5%B8%81/" class="article-date">
  <time datetime="2020-02-24T08:45:05.000Z" itemprop="datePublished">2020-02-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/24/%E7%90%86%E8%A7%A3%E6%AF%94%E7%89%B9%E5%B8%81/">理解比特币</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-比特币是什么？"><a href="#1-比特币是什么？" class="headerlink" title="1. 比特币是什么？"></a>1. 比特币是什么？</h1><p>​        <strong>比特币</strong>是基于区块链技术的一种数字货币实现，比特币网络是历史上首个经过大规模、长时间检验的数字货币系统。</p>
<p>​        <strong>比特币网络</strong>是一个分布式的点对点网络，网络中的矿工通过“挖矿”来完成对交易记录的记账过程，维护网络的正常运作。</p>
<p>​        <strong>区块链网络</strong>提供了一个公共可见的记账本，该记账本并非记录每个账户的余额，而是用来记录发生过的交易的历史信息。</p>
<p><strong>比特币网络在功能上具有如下特点：</strong></p>
<ul>
<li>去中心化：意味着没有任何独立个体可以对网络中的交易进行破坏，任何交易请求都需要大多数参与者的共识</li>
<li>匿名性：比特币网络中账户是匿名的，无法从交易信息关联到具体的个体，但也意味着很难进行审计</li>
<li>通胀预防：比特币的发行需要通过挖矿计算来进行，发行量每四年减半，总量上限2100万枚，无法被超发</li>
</ul>
<p><strong>比特币事件：</strong></p>
<ul>
<li>2008年10月31日，中本聪发布了比特币唯一的白皮书：<a target="_blank" rel="noopener" href="https://www.8btc.com/wiki/bitcoin-a-peer-to-peer-electronic-cash-system">（比特币：一种点对点的电子现金系统）</a></li>
<li>2009年1月3日。中本聪在位于芬兰的一个小型服务器上挖出第一批50个比特币。</li>
</ul>
<h1 id="2-比特币如何运作？"><a href="#2-比特币如何运作？" class="headerlink" title="2. 比特币如何运作？"></a>2. 比特币如何运作？</h1><h2 id="2-1-比特币核心程序：客户端"><a href="#2-1-比特币核心程序：客户端" class="headerlink" title="2.1 比特币核心程序：客户端"></a>2.1 比特币核心程序：客户端</h2><p>​        比特币是一个软件，是软件就需要运行。</p>
<p>客户端的功能模块：</p>
<ul>
<li>钱包</li>
<li>完整区块链：保留了完整的区块链账本数据</li>
<li>网络路由：</li>
<li>挖矿（可以独立部署）</li>
</ul>
<h2 id="2-2-比特币的发行：挖矿"><a href="#2-2-比特币的发行：挖矿" class="headerlink" title="2.2 比特币的发行：挖矿"></a>2.2 比特币的发行：挖矿</h2><p>​        “挖矿”是一种算法，（字面意思，投入某种工作，得到一种“宝贝”）。</p>
<p><strong>挖矿在比特币软件中的用途：</strong></p>
<ul>
<li>抢夺区块打包权</li>
<li>验证交易事物</li>
<li>奖励发行新币</li>
<li>广播新区块</li>
</ul>
<p>​        比特币是一个对等网络，每个节点都可以独立维护自己的数据副本，那么如何保证彼此之间的数据一致呢？</p>
<p>​        这就带有一个约定的规则，大家共同按照这个规则来竞争数据的打包权，打包完成后广播给别人，别人只要验证一下就行，没问题就存入自己的数据文件中。</p>
<p>​        比特币采用工作量证明（PoW）的一种算法。谁先计算出符合难度的数字，谁就抢到了打包权。</p>
<h3 id="1-难度值"><a href="#1-难度值" class="headerlink" title="1. 难度值"></a>1. 难度值</h3><p>​        首先，既然大家都在竞争，那计算的数字必须要符合一个难度，这个难度就是门槛。</p>
<p>​        作为难度1的目标值。在比特币诞生初期，当时全网算力，大约10分钟得到一个符合难度1要求的值，这也是每个10分钟一个区块的来源、。</p>
<ul>
<li>difficulty ： 难度级别</li>
<li>nonce：随机数</li>
<li>bits：存储难度的十六进制目标值</li>
</ul>
<p>全网 算力越强，difficulty 难度值就越大，bits 的目标值就越小。</p>
<p>新的难度值计算公式：新难度值 = 当前难度值 * （最近2016个区块的实际出块时间/ 20160分钟）</p>
<h3 id="2-挖矿计算"><a href="#2-挖矿计算" class="headerlink" title="2. 挖矿计算"></a>2. 挖矿计算</h3><p>挖矿的计算公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHA256（ SHA256（version + prev_hash + merkle_root + ntime + nbits + nonce）） &lt; Target 难度目标值</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>区块的版本号</td>
</tr>
<tr>
<td>prev_hash</td>
<td>前一个区块的哈希值</td>
</tr>
<tr>
<td>merkle_root</td>
<td>准备打包的交易事物哈希树的根植，也就是梅克尔根  <strong>（可以改变）</strong></td>
</tr>
<tr>
<td>ntime</td>
<td>区块时间戳  <strong>（可以改变）</strong></td>
</tr>
<tr>
<td>nbits</td>
<td>当前难度</td>
</tr>
<tr>
<td>nonce</td>
<td>随机值   <strong>（可以改变）</strong></td>
</tr>
</tbody></table>
<p>​        <strong>挖矿就是重复计算区块头的哈希值，不断修改该参数，直到与难度目标值匹配的一个过程。</strong></p>
<p>​        矿工的奖励，是作为一条交易事物包含在区块的交易事务中，相当于系统给矿工转账了一笔比特币，这种交易事物由于特殊性，通常称为 coinbase 交易。这个交易一般是位于区块中的第一条，比特币系统也是通过这种挖矿奖励的方式发行新的比特币，就像央行发行新钞一样。</p>
<h3 id="3-区块广播"><a href="#3-区块广播" class="headerlink" title="3. 区块广播"></a>3. 区块广播</h3><p>​        矿工挖出区块后，就进行网络广播，传递给相邻的节点，节点接收到新的区块后会进行一系列的验证，比如区块数据格式是否正确；区块头的哈希值小于目标难度了区块时间戳是否在允许范围之内；区块中第一个交易（且只有第一个）是coinbase交易；区块中的交易事物是否有效等。全部通过就会把新的区块数据纳入到自己的区块链账本中。如果是挖矿接地那收到消息，就会理解停止当前的挖矿计算，转而进行下一个区块的竞争。</p>
<p>​        如果同一时间内多个矿工都计算出符合条件的值，都拥有了打包权，那以谁为准？比特币中的解决方案，就是让节点自己选择，最终传播最广、处于最长链中的区块将保留，因此到底谁的区块会被保留下来，就要看运气了。</p>
<p>​        挖矿的作用，除了发行新的比特币外，主要就是维持网络共识，让每个节点对区块链书籍保持最终一致性。</p>
<h3 id="4-挖矿方式"><a href="#4-挖矿方式" class="headerlink" title="4. 挖矿方式"></a>4. 挖矿方式</h3><p>​        </p>
<h2 id="2-3-比特币的钱包：核心钱包和轻钱包"><a href="#2-3-比特币的钱包：核心钱包和轻钱包" class="headerlink" title="2.3 比特币的钱包：核心钱包和轻钱包"></a>2.3 比特币的钱包：核心钱包和轻钱包</h2><p>​        钱包，是属于比特币系统中的一个前端工具，最基本的功能就是用来管理用户的比特币地址、发起转账交易、查看交易记录等。</p>
<h3 id="比特币地址的生成过程"><a href="#比特币地址的生成过程" class="headerlink" title="比特币地址的生成过程"></a>比特币地址的生成过程</h3><p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc8fosaa43j30s30gndhl.jpg" alt="page65image2621648.jpg"> </p>
<ol>
<li>首先使用随机数发生器生成一个私钥</li>
<li>私钥经过 SECP256K1（是一种特定的椭圆曲线算法） 算法生成公钥。 （不能通过公钥生成私钥）</li>
<li>公钥接下来先使用 SHA256 ，再使用 RIPEMD160 哈希算法，计算出公钥哈希。比特币的代码通过2次哈斯来计算地址值，进一步确保哈希后的数据的唯一性。</li>
<li>将一个地址版本号链接到公钥哈希，然后对其进行两次 SHA256 运算，将计算结果取前面4字节作为公钥哈希的校验值</li>
<li>将版本号与公钥哈希以及校验值连接起来，然后进行 BASE58 编码转换，最终得到比特币地址。</li>
</ol>
<p>简化过程：</p>
<p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc8fxyuqwlj30u402eglt.jpg" alt="page66image2817472.jpg"> </p>
<h3 id="SPV钱包的大致过程"><a href="#SPV钱包的大致过程" class="headerlink" title="SPV钱包的大致过程"></a>SPV钱包的大致过程</h3><ol>
<li>首先下载完整的区块头数据，注意是区块头，而不是所有的区块链数据，这样可以大大减少需要获取的账本数据量，区块头中包含中区块的梅克尔根，SPV方式主要就是靠它来实现的。</li>
<li>如果要验证某笔支付交易，则计算出这笔交易事物的哈希值 txHash。</li>
<li>找到txHash所在的区块，验证一下所在区块的区块头是否包含在账本数据中。</li>
<li>获得所在区块中计算梅克尔根所需要的哈希值</li>
<li>计算出梅克尔根</li>
<li>若计算结果与所在区块的梅克尔根相等，则支付交易是存在的。</li>
<li>根据该区块所处的高度位置，还可以确定该交易得到了多少个确认。</li>
</ol>
<h2 id="2-4-比特币的账户模型：UTXO"><a href="#2-4-比特币的账户模型：UTXO" class="headerlink" title="2.4 比特币的账户模型：UTXO"></a>2.4 比特币的账户模型：UTXO</h2><p>​        比特币中交易事物的数据结构，UTXO（Unspent Transaction Output，“未花费事务输出”）。        </p>
<p><img src="https://tva1.sinaimg.cn/large/0082zybply1gc8gby8jfcj30rn0nu41j.jpg" alt="page72image3005968.jpg"> </p>
<p>​        上图展示了比特币中的交易事物结构，在比特币的交易事物数据中，存储的就是这样的输入和输出，相当于仓库中的进出流水账，并且“输入”和“输出”彼此对应，或者更准确地说，“输入”就是指向之前的“输出”。</p>
<ol>
<li>001号交易为 Coinbase 交易，也就是挖矿交易，这个交易中，“输入”部分没有用对应的“输出”，而是由系统直接奖励发行比特币，矿工 Alice 得到12.5个比特币的奖励，放在001号交易的“输出”部分。此时，对于Alice来说，拥有了这12.5个比特币的支配权，这个12.5个比特币的输出可以作为下一笔交易的“输入”，顾名思义，这逼“输出”就称之为是Alice的未花费输出，也就是Alice的UTXO的意思。</li>
<li>002号交易中，ALice转账6比特币到Bob的地址，Alice找到了自己的UTXO（如果Alice不止一笔UTXO，可以根据一定的规则去选用。比如将小金额的先花费掉）。由于只需要转账6比特币，可以UTXO中却有12.5个，因此需要找零6.5个到自己的地址中，由此产生了002号中的交易输出</li>
</ol>
<h3 id="UTXO"><a href="#UTXO" class="headerlink" title="UTXO"></a>UTXO</h3><ol>
<li>比特币的交易不是通过账户的增减来实现的，而是一笔笔关联的输入/输出交易事物。</li>
<li>每一笔的交易都要花费”输入”，然后产出”输出“，这个产生的”输出“就是所谓的”未花费过的交易输出“，也就是UTXO。每一笔交易事物都有一个唯一的标号，称为交易事物ID，这是通过哈希算法计算而来的，当需要引用某一笔交易事物中的”输出“时，主要提供交易事物ID和所处”输出“列表中的序号就可以了。</li>
<li>由于没有账户的概念，因此当“输入”部门的金额大于所需的“输出”时，必须给自己找零，这个找零也是作为交易的一部分包含在“输出”中。</li>
</ol>
<h3 id="怎么证明哪一条UTXO是属于谁？"><a href="#怎么证明哪一条UTXO是属于谁？" class="headerlink" title="怎么证明哪一条UTXO是属于谁？"></a>怎么证明哪一条UTXO是属于谁？</h3><p>​        在比特币中，是使用输入脚本和输出脚本程序实现的，有时候也称为“锁定脚本”和”解锁脚本”。简单地说，就是通过“锁定脚本”，利用私钥签名解锁自己的某一条UTXO（也就是之前的“输出”），然后使用对方的公钥锁定新的“输出”，成功后，这笔新的“输出”就成为了对方的UTXO。</p>
<p>​        同样，对方也可以使用“锁定脚本”和“解锁脚本”来实现转账。这个脚本程序其实本质上就可以看成是比特币的数字合约，这也是为什么比特币被称为可以变成数字货币的原因。</p>
<h1 id="3-比特币存在什么问题？"><a href="#3-比特币存在什么问题？" class="headerlink" title="3. 比特币存在什么问题？"></a>3. 比特币存在什么问题？</h1><h2 id="3-1-软分叉和硬分叉"><a href="#3-1-软分叉和硬分叉" class="headerlink" title="3.1 软分叉和硬分叉"></a>3.1 软分叉和硬分叉</h2><p>软分叉：新版本接地那认为老版本节点发出的区块/交易合法</p>
<p>硬分叉：新版本节点认为老版本节点发出的区块/交易不合法</p>
<p>![page353image2752512.jpg](/Users/wengcheng/Library/Application Support/typora-user-images/page353image2752512.jpg) ![page353image2758752.jpg](/Users/wengcheng/Library/Application Support/typora-user-images/page353image2758752.jpg) </p>
<h2 id="3-2-51-的攻击"><a href="#3-2-51-的攻击" class="headerlink" title="3.2 51%的攻击"></a>3.2 51%的攻击</h2><p>当打包权在自己手中能干什么：</p>
<ol>
<li>修改自己的交易记录，从而实现双花</li>
<li>阻止区块确认部分或者全部交易</li>
<li>阻止其他矿工开采到区块</li>
</ol>
<p>51%攻击实现不了的：</p>
<ol>
<li>修改他人的交易记录（没有他人的密钥）</li>
<li>凭空产生比特币（（其他节点不会通过确认，达不成网络共识）</li>
<li>改版每区块的比特币发行数量</li>
<li>把不属于自己的比特币发给别人或自己</li>
<li>修改历史区块数据</li>
</ol>
<h2 id="3-3-轻钱包的易攻击性"><a href="#3-3-轻钱包的易攻击性" class="headerlink" title="3.3 轻钱包的易攻击性"></a>3.3 轻钱包的易攻击性</h2><p>SPV，用户只需要保存所有的区块头，由于只保留区块头，因此用户自己不能验证交易，需要从区块链某处找到相符的交易，才能得知认可情况。</p>
<h2 id="3-4-私钥丢失"><a href="#3-4-私钥丢失" class="headerlink" title="3.4 私钥丢失"></a>3.4 私钥丢失</h2><h2 id="3-5-重放攻击：交易延展性"><a href="#3-5-重放攻击：交易延展性" class="headerlink" title="3.5 重放攻击：交易延展性"></a>3.5 重放攻击：交易延展性</h2><p>​        在自然界，改变某些材料的形状，但是本质不会改变，就叫延展性。</p>
<p>​        延展性攻击后，会产生新的事物ID，会导致以下后果：</p>
<ol>
<li>接收方无法通过原始的事物ID来查询这笔转账</li>
<li>被修改过的交易会与其余在网络中传播的原始交易争抢进入区块，一旦抢先进入新的区块，原始交易就会被网络中的节点拒绝</li>
<li>阻止原始的交易进入区块</li>
</ol>
<h2 id="3-6-网络拥堵：大量交易的确认延迟"><a href="#3-6-网络拥堵：大量交易的确认延迟" class="headerlink" title="3.6 网络拥堵：大量交易的确认延迟"></a>3.6 网络拥堵：大量交易的确认延迟</h2><h2 id="3-7-不断增长的区块数据"><a href="#3-7-不断增长的区块数据" class="headerlink" title="3.7 不断增长的区块数据"></a>3.7 不断增长的区块数据</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2020/02/24/%E7%90%86%E8%A7%A3%E6%AF%94%E7%89%B9%E5%B8%81/" data-id="ckvtb0r5b000df2f6clxifd0z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%81%E6%AF%94%E7%89%B9%E5%B8%81/" rel="tag">区块链、比特币</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-diary-20190829" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/30/diary-20190829/" class="article-date">
  <time datetime="2019-08-29T16:04:53.000Z" itemprop="datePublished">2019-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/30/diary-20190829/">diary-20190829</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​        早上开车的时候，听余秋雨讲儒释道，道家的思想是做”真人“，释，也就是佛的思想是做”觉者“，儒的思想是做”君子“。成人之美，不成人之恶，这是君子和小人最大的区别。君子坦荡荡，小人长戚戚。</p>
<p>​        今天白天，把今天插旗的日常开发完成了。小程序前后端调试真是不方便，老是忘记前端调用那个接口。由于这次改动涉及多个接口，调试的时候老是出现接口遗漏的情况。</p>
<p>​        针对插旗2.8的需求，还是针对用户注册流程做了调整，并且，公众号注册的时候也要实现用户注册功能。</p>
<p>​        今天周会的时候，听刚锐分享了薅羊毛的事情。才发现，原来我们身边有许多不知道的灰色产业链。往往都是脱离了监管的灰色产业，才会给那么胆大的人谋利。就想最近很火的《全裸导演》中关于日本情色产业。</p>
<p>​        明天要和少庆一起过下2.8的整体方案。算上今天，正式开始拜读杨绛的《走到人生边上》。</p>
<p>​        </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/08/30/diary-20190829/" data-id="ckvtb0r530005f2f6hovx8ybd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E5%9B%9B/" rel="tag">diary 星期四</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-diary-20190828" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/28/diary-20190828/" class="article-date">
  <time datetime="2019-08-28T14:44:08.000Z" itemprop="datePublished">2019-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/28/diary-20190828/">diary-20190828</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​        早上上班路上，听了余秋雨的“每个人都要有自己的艺术感觉”。好吧，我赞同余秋雨的观点，学校里背诵的诗词和课文，现在已经不知道忘记到哪里去了。想想，对我的艺术感觉并没有什么作用。还是说我根本就没有。只能怪我书读得太少了，培养不起我的艺术感觉。等大圣长大点，我要他和我一起多读书。多读书总是好的。</p>
<p>​        早上站会之前，终于把杨绛的“我们仨”看完了。看到结果，1997年，女儿走了；1998年，丈夫也走了。独留她一人独自思念。眼泪又不争气的留下来了。留她一个人生活那么久，思念一定非常苦。我希望我和阿登不要太煎熬。佛教曰：人生有八苦，生、老、病、死、爱别离、怨憎会、求不得、五阴炽盛。尽然，别离不可避免，只能希望痛苦能少一点、少一点。</p>
<p>​        本来今天上午是计划在新的 Nginx 上测试的，但是 SA 的同事，拖到下班都迟迟没有完成 Nginx 的初始化。不知道明天能不能联调，不能再拖下去了。多一天，就要多付一天的机器钱。</p>
<p>​        今天，冯超针对支付并加入的接口做性能测试，发现接口性能一直上不去。一直从200，100，50。后台才发现，单机的 JDBC 配置了30。测试的并发量远远大于 30，并且这个接口中有大量的数据库操作，一个请求大量持有 JDBC 连接，所以性能一直上不去，瓶颈在数据库连接上。要优化的话，只能减少单台机器上的JDBC连接了。或者，进行读写分离。或者，通过异步消息，将其他逻辑转移到其他机器上处理。</p>
<p>​        最后，这个接口一致降到了50并发，然后配置 Hystrix 。配置的时候才发现，对 Hystrix 的配置了解太少了。打算稍微了解下。《Spring Cloud 微服务实战》看了一部分，稍微了解了 Hystrix 的处理流程。明天再把详细的参数了解下。</p>
<p>​        晚上，看了《命运之夜——天之杯II ：迷失之蝶》。最后一部要2020年上映。虽然已经快30了，看了还是感觉很燃。间桐樱这个角色真的可怜，从小被送出去，还被名义上的哥哥欺辱。希望第三部，卫宫士郎能救下樱吧。还是希望是个完美结局吧。牺牲少数人，拯救大多数人。我这种思想败坏得人，估计是为了喜欢的人，屠戮上万人的吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/08/28/diary-20190828/" data-id="ckvtb0r580009f2f6dgtvb0y4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%B8%89/" rel="tag">diary 星期三</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-diary-20190827" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/27/diary-20190827/" class="article-date">
  <time datetime="2019-08-27T11:36:08.000Z" itemprop="datePublished">2019-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/27/diary-20190827/">diary-20190827</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​        8月25日（周日）晚上，为了把周六追的小说（炼狱天使）看完，一直到凌晨1点才上床睡觉。期间，阿登命令我上床睡觉，我因为想把小说看完，就拒绝了她。她很生气，把卧室的房门给锁了，让我一个人在客厅看小说。好吧，因为这件事我把她给惹毛了，一连好几天都在生我的气。今天是第二天。</p>
<p>​        我不善于交际，因此，每天都是公司-家，两点一线。平时和其他人也没有什么来往。我经常和阿登吐槽我两的交际圈太小，不过她应该比我好。因为她周末还不时的和同事出去玩，而我却没有，即使有我，一般也不会出去。</p>
<p>​        这样的环境，游戏和小说就成了我的最爱。大学的时候还因为游戏，被阿登给甩了，失去了才懂得珍惜。第一次躺在阿登宿舍楼下的小树下，一边喝酒一边等着她的出现，想远远再看她一眼。后来等久了，开始给认识的人打电话聊天。（现在想想，估计那时候是发酒疯了）应该是他们告诉了阿登，然后阿登找到了躺在树下的我。那天晚上，把着阿登的时候，我才发现离开了她，我会多么痛苦。后来，我死皮赖脸的由追求她，然后工大的某个下午，我两复合了。</p>
<p>​        有了大圣之后，现在游戏基本不玩了。但是小说还在看，网上的快餐小说看了一本又一本。孤寂的我把看小说变成生活中的一部分了。虽然看了很多，但是自己的内心世界并不强大。下班开车回家，看着沿途的风景，内心更空荡，在这个城市中生活，并没有更多的幸福感。</p>
<p>​        我告诉阿登，我想看一些文学作品，希望能丰富我的精神世界。她推荐我看徐秋雨、钱钟书、杨绛的书。</p>
<p>​        早上开车的路上，在喜马拉雅上听余秋雨讲“学会苦难中寻找幸福”，他说“幸福感是自己挖掘的，如果你没有幸福感，很可能是生活方式不对”。好吧，我开始尝试改变自己的生活习惯，尽量少看快餐小说，多看看文学作品，尝试每天晚上写日记，记录生活中的点滴。</p>
<p>​        杨绛的“我们仨”看了大半了，女儿60岁就死了，然后钱钟书也去了，她一个人独自活到了100多岁。看着开头，女儿和丈夫相继去世，我的眼泪忍不住留下来了。只剩下她一个人开始思念他们仨。</p>
<p>​        都说陪伴是最长情的告白。以前我告诉阿登，我要比她先走，这样我就不用过离开她的日子了。现在想想，自己真是自私，怎么可以让她忍受那种煎熬呢。我要陪着她，陪着她离开。为了以后能想起生活中的点滴，我开始写日记，多记录她和大圣。希望日后能回想起现在的点点滴滴。</p>
<p>​        </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/08/27/diary-20190827/" data-id="ckvtb0r500004f2f621ubectn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%BA%8C/" rel="tag">diary 星期二</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用WxJava开发微信公众号" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/03/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" class="article-date">
  <time datetime="2019-06-03T06:35:15.000Z" itemprop="datePublished">2019-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/03/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/">使用WxJava开发微信公众号</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="公众号-服务号-配置"><a href="#公众号-服务号-配置" class="headerlink" title="公众号(服务号)配置"></a>公众号(服务号)配置</h2><p>利用 <code>weixin-java-mp</code> 配置 appId 和 secret 。</p>
<ol>
<li><p>添加pom.xml依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.github.binarywang&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;weixin-java-mp&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;3.3.8.B&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>添加<code>application.yml</code>配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">wx</span>:  <span class="string"></span></span><br><span class="line">  <span class="attr">mp</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">configs</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">appId: xxx #（一个公众号的appid）（测试平台账号）</span></span><br><span class="line">        <span class="attr">secret</span>: <span class="string">xxx</span></span><br><span class="line">        <span class="attr">token</span>: <span class="string">test_token #（接口配置里的Token值）</span></span><br><span class="line">        <span class="attr">aesKey</span>: <span class="string">iKVJDUh1yWR7PWB83D7z93HLn48wILNMU4Ls8A681pK #（接口配置里的EncodingAESKey值）</span></span><br></pre></td></tr></table></figure></li>
<li><p>Java配置</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;wx.mp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpProperties</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> List&lt;MpConfig&gt; configs;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Data</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MpConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的appid</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的app secret</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的token</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置微信公众号的EncodingAESKey</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">private</span> String aesKey;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WxMpProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpServiceConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> WxMpProperties properties;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WxMpService <span class="title">wxMpService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;WxMpProperties.MpConfig&gt; configs = <span class="keyword">this</span>.properties.getConfigs();</span><br><span class="line">    <span class="keyword">if</span> (configs == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;大哥，拜托先看下项目首页的说明（readme文件），添加下相关配置，注意别配错了！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WxMpService service = <span class="keyword">new</span> WxMpServiceImpl();</span><br><span class="line">    Map&lt;String, WxMpConfigStorage&gt; collect = configs</span><br><span class="line">      .stream().map(a -&gt; &#123;</span><br><span class="line">      WxMpInMemoryConfigStorage configStorage = <span class="keyword">new</span> WxMpInMemoryConfigStorage();</span><br><span class="line">      configStorage.setAppId(a.getAppId());</span><br><span class="line">      configStorage.setSecret(a.getSecret());</span><br><span class="line">      configStorage.setToken(a.getToken());</span><br><span class="line">      configStorage.setAesKey(a.getAesKey());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> configStorage;</span><br><span class="line">    &#125;).collect(Collectors.toMap(WxMpInMemoryConfigStorage::getAppId, a -&gt; a, (o, n) -&gt; o));</span><br><span class="line">    service.setMultiConfigStorages(collect);</span><br><span class="line">    <span class="keyword">return</span> service;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;xxx/&#123;appid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpPortalController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> WxMpServiceAdapter wxAdapter;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">authGet</span><span class="params">(<span class="meta">@PathVariable</span> String appid,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;signature&quot;, required = false)</span> String signature,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;timestamp&quot;, required = false)</span> String timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;nonce&quot;, required = false)</span> String nonce,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;echostr&quot;, required = false)</span> String echostr)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;请求参数非法，请核实!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wxAdapter.switchover(appid)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">&quot;未找到对应appid=[%s]的配置，请核实！&quot;</span>, appid));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wxAdapter.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">      <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="access-token"><a href="#access-token" class="headerlink" title="access_token"></a>access_token</h2><p>​    同小程序一样。公众号大部分接口都是需要 access_token 。</p>
<p>​    <code>me.chanjar.weixin.mp.api.impl.BaseWxMpServiceImpl#executeInternal</code>，每次发送请求的时候也会获取 access_token。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T, E&gt; <span class="function">T <span class="title">executeInternal</span><span class="params">(RequestExecutor&lt;T, E&gt; executor, String uri, E data)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  String accessToken = getAccessToken(<span class="keyword">false</span>);</span><br><span class="line">  String uriWithAccessToken = uri + (uri.contains(<span class="string">&quot;?&quot;</span>) ? <span class="string">&quot;&amp;&quot;</span> : <span class="string">&quot;?&quot;</span>) + <span class="string">&quot;access_token=&quot;</span> + accessToken;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    T result = executor.execute(uriWithAccessToken, data);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>me.chanjar.weixin.mp.api.WxMpService#getAccessToken(boolean)</code> 针对不同的api，有3种实现类</p>
<ul>
<li>me.chanjar.weixin.mp.api.impl.WxMpServiceHttpClientImpl</li>
<li>me.chanjar.weixin.mp.api.impl.WxMpServiceJoddHttpImpl</li>
<li>me.chanjar.weixin.mp.api.impl.WxMpServiceOkHttpImpl</li>
</ul>
<p>以 <code>WxMpServiceHttpClientImpl </code>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAccessToken</span><span class="params">(<span class="keyword">boolean</span> forceRefresh)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.getWxMpConfigStorage().isAccessTokenExpired() &amp;&amp; !forceRefresh) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getWxMpConfigStorage().getAccessToken();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Lock lock = <span class="keyword">this</span>.getWxMpConfigStorage().getAccessTokenLock();</span><br><span class="line">  lock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    String url = String.format(WxMpService.GET_ACCESS_TOKEN_URL,</span><br><span class="line">                               <span class="keyword">this</span>.getWxMpConfigStorage().getAppId(), <span class="keyword">this</span>.getWxMpConfigStorage().getSecret());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.getRequestHttpProxy() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RequestConfig config = RequestConfig.custom().setProxy(<span class="keyword">this</span>.getRequestHttpProxy()).build();</span><br><span class="line">        httpGet.setConfig(config);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> (CloseableHttpResponse response = getRequestHttpClient().execute(httpGet)) &#123;</span><br><span class="line">        String resultContent = <span class="keyword">new</span> BasicResponseHandler().handleResponse(response);</span><br><span class="line">        WxError error = WxError.fromJson(resultContent, WxType.MP);</span><br><span class="line">        <span class="keyword">if</span> (error.getErrorCode() != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> WxErrorException(error);</span><br><span class="line">        &#125;</span><br><span class="line">        WxAccessToken accessToken = WxAccessToken.fromJson(resultContent);</span><br><span class="line">        <span class="keyword">this</span>.getWxMpConfigStorage().updateAccessToken(accessToken.getAccessToken(), accessToken.getExpiresIn());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getWxMpConfigStorage().getAccessToken();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        httpGet.releaseConnection();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    公众号中，存储 token 的接口是 <code>me.chanjar.weixin.mp.api.WxMpConfigStorage</code>。它的实现类有</p>
<ul>
<li><p>me.chanjar.weixin.mp.api.WxMpInMemoryConfigStorage 基于本地内存实现</p>
</li>
<li><p>me.chanjar.weixin.mp.api.WxMpInRedisConfigStorage  基于 JedisPool 实现</p>
<p>因为项目中使用 RedisTemplate，因此参考 WxMpInRedisConfigStorage 重写了一个基于 RedisTemplate 实现的 WxMpConfigStorage 实现类。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CqWxMpInRedisConfigStorage</span> <span class="keyword">extends</span> <span class="title">WxMpInMemoryConfigStorage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCESS_TOKEN_KEY = <span class="string">&quot;cq:wx:access_token:&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String UPDATE_ACCESS_TOKEN_LOOK_KEY = <span class="string">&quot;cq:wx:access_token:lock:updating&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> String accessTokenKey;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CqWxMpInRedisConfigStorage</span><span class="params">(RedisTemplate redisTemplate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每个公众号生成独有的存储key.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppId</span><span class="params">(String appId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.setAppId(appId);</span><br><span class="line">    <span class="keyword">this</span>.accessTokenKey = ACCESS_TOKEN_KEY.concat(appId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getTicketRedisKey</span><span class="params">(TicketType type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;cq:wx:ticket:key:%s:%s&quot;</span>, <span class="keyword">this</span>.appId, type.getCode());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getAccessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(<span class="keyword">this</span>.accessTokenKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token 是否已经过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccessTokenExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !redisTemplate.hasKey(accessTokenKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateAccessToken</span><span class="params">(String accessToken, <span class="keyword">int</span> expiresInSeconds)</span> </span>&#123;</span><br><span class="line">    String lockStr = UPDATE_ACCESS_TOKEN_LOOK_KEY;</span><br><span class="line">    RedisLock lock = <span class="keyword">new</span> RedisLock(redisTemplate);</span><br><span class="line">    <span class="keyword">if</span> (lock.lock(lockStr)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="keyword">this</span>.accessTokenKey, accessToken);</span><br><span class="line">        redisTemplate.expire(<span class="keyword">this</span>.accessTokenKey, expiresInSeconds - <span class="number">200</span>, TimeUnit.SECONDS);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;获取锁&quot;</span> + lockStr + <span class="string">&quot;异常&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(lockStr);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.error(<span class="string">&quot;updateAccessToken: get lock &quot;</span> + lockStr + <span class="string">&quot; failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">expireAccessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    redisTemplate.expire(<span class="keyword">this</span>.accessTokenKey, <span class="number">0</span>, TimeUnit.SECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">(TicketType type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(<span class="keyword">this</span>.getTicketRedisKey(type));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTicketExpired</span><span class="params">(TicketType type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !redisTemplate.hasKey(<span class="keyword">this</span>.getTicketRedisKey(type));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateTicket</span><span class="params">(TicketType type, String jsapiTicket, <span class="keyword">int</span> expiresInSeconds)</span> </span>&#123;</span><br><span class="line">    String lockStr = UPDATE_ACCESS_TOKEN_LOOK_KEY;</span><br><span class="line">    RedisLock lock = <span class="keyword">new</span> RedisLock(redisTemplate);</span><br><span class="line">    <span class="keyword">if</span> (lock.lock(lockStr)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="keyword">this</span>.getTicketRedisKey(type), jsapiTicket);</span><br><span class="line">        redisTemplate.expire(<span class="keyword">this</span>.getTicketRedisKey(type), expiresInSeconds - <span class="number">200</span>, TimeUnit.SECONDS);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;updateTicket&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock(lockStr);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.error(<span class="string">&quot;updateTicket: get lock &quot;</span> + lockStr + <span class="string">&quot; failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">expireTicket</span><span class="params">(TicketType type)</span> </span>&#123;</span><br><span class="line">    redisTemplate.expire(<span class="keyword">this</span>.getTicketRedisKey(type), <span class="number">0</span>, TimeUnit.SECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Data</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessToken</span> </span>&#123;</span><br><span class="line">    String accessToken;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    并且在配置 WxMpService 的时候，使用自定义 CqWxMpInRedisConfigStorage 替换 WxMpInMemoryConfigStorage。</p>
<h2 id="接入测试平台"><a href="#接入测试平台" class="headerlink" title="接入测试平台"></a>接入测试平台</h2><p>​    由于微信公众号(服务号)认证成本较高，因此提供了 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index">微信公众平台接口调试工具</a> 。</p>
<p>​    <strong>测试号信息</strong> 提供了测试号的 appID 和 appsecret，需要配置在后端应用中。</p>
<p>​    <strong>接口配置信息</strong> 配置后端的接口。</p>
<h2 id="消息管理"><a href="#消息管理" class="headerlink" title="消息管理"></a>消息管理</h2><h3 id="服务号通知配置"><a href="#服务号通知配置" class="headerlink" title="服务号通知配置"></a>服务号通知配置</h3><p>​    在使用公众号 消息管理 前，需要在 <code>开发 》基础配置 》服务器配置</code> 配置开发者配置。</p>
<h3 id="接收事件推送"><a href="#接收事件推送" class="headerlink" title="接收事件推送"></a>接收事件推送</h3><h4 id="关注-取消关注事件"><a href="#关注-取消关注事件" class="headerlink" title="关注/取消关注事件"></a>关注/取消关注事件</h4><p>​    用户在关注与取消关注公众号时，微信会把这个事件推送到开发者填写的URL。方便开发者给用户下发欢迎消息或者做帐号的解绑。为保护用户数据隐私，开发者收到用户取消关注事件时需要删除该用户的所有信息。</p>
<p>推送XML数据包示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;ToUserName&gt;&lt;![CDATA[toUser]]&gt;&lt;/ToUserName&gt;</span><br><span class="line">  &lt;FromUserName&gt;&lt;![CDATA[FromUser]]&gt;&lt;/FromUserName&gt;</span><br><span class="line">  &lt;CreateTime&gt;123456789&lt;/CreateTime&gt;</span><br><span class="line">  &lt;MsgType&gt;&lt;![CDATA[event]]&gt;&lt;/MsgType&gt;</span><br><span class="line">  &lt;Event&gt;&lt;![CDATA[subscribe]]&gt;&lt;/Event&gt;  </span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ToUserName</td>
<td align="left">开发者微信号</td>
</tr>
<tr>
<td align="left">FromUserName</td>
<td align="left">发送方帐号（一个OpenID）</td>
</tr>
<tr>
<td align="left">CreateTime</td>
<td align="left">消息创建时间 （整型）</td>
</tr>
<tr>
<td align="left">MsgType</td>
<td align="left">消息类型，event</td>
</tr>
<tr>
<td align="left">Event</td>
<td align="left">事件类型，subscribe(订阅)、unsubscribe(取消订阅)</td>
</tr>
</tbody></table>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><blockquote>
<ol>
<li>由于微信公众号的<strong>UnionID机制</strong>，一个用户同时关注公众号和小程序，会有两个OpenID和一个UnionID。但是前提是需要在 <a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">微信开放平台</a> 上同时绑定 公众号和小程序。</li>
</ol>
</blockquote>
<h4 id="Java示例"><a href="#Java示例" class="headerlink" title="Java示例"></a>Java示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WxMpProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpServiceConfiguration</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> LogHandler logHandler;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UnsubscribeHandler unsubscribeHandler;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> SubscribeHandler subscribeHandler;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WxMpMessageRouter <span class="title">messageRouter</span><span class="params">(WxMpService wxMpService)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WxMpMessageRouter newRouter = <span class="keyword">new</span> WxMpMessageRouter(wxMpService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录所有事件的日志 （异步执行）</span></span><br><span class="line">    newRouter.rule().handler(<span class="keyword">this</span>.logHandler).next();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关注事件</span></span><br><span class="line">    newRouter.rule().async(<span class="keyword">false</span>).msgType(WxConsts.XmlMsgType.EVENT)</span><br><span class="line">      .event(WxConsts.EventType.SUBSCRIBE).handler(<span class="keyword">this</span>.subscribeHandler)</span><br><span class="line">      .end();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消关注事件</span></span><br><span class="line">    newRouter.rule().async(<span class="keyword">false</span>).msgType(WxConsts.XmlMsgType.EVENT)</span><br><span class="line">      .event(WxConsts.EventType.UNSUBSCRIBE)</span><br><span class="line">      .handler(<span class="keyword">this</span>.unsubscribeHandler).end();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newRouter;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandler</span> <span class="keyword">implements</span> <span class="title">WxMpMessageHandler</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBuilder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> WxMpXmlOutMessage <span class="title">build</span><span class="params">(String content,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            WxMpXmlMessage wxMessage, WxMpService service)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Map&lt;String, Object&gt; context, WxMpService wxMpService,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    WxSessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;\n接收到请求消息，内容：&#123;&#125;&quot;</span>, JSONObject.toJSONString(wxMessage));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Map&lt;String, Object&gt; context,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    WxMpService weixinService,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    WxSessionManager sessionManager)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;新关注用户 OPENID: &quot;</span> + wxMessage.getFromUser());</span><br><span class="line">        <span class="comment">// 获取微信用户基本信息</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WxMpUser userWxInfo = weixinService.getUserService().userInfo(wxMessage.getFromUser(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (userWxInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 可以添加关注用户到本地数据库</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.getError().getErrorCode() == <span class="number">48001</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;该公众号没有获取用户信息权限！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WxMpXmlOutMessage responseResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            responseResult = <span class="keyword">this</span>.handleSpecial(wxMessage);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> responseResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TextBuilder().build(<span class="string">&quot;感谢关注&quot;</span>, wxMessage, weixinService);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理特殊请求，比如如果是扫码进来的，可以做相应处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> WxMpXmlOutMessage <span class="title">handleSpecial</span><span class="params">(WxMpXmlMessage wxMessage)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//TODO</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextBuilder</span> <span class="keyword">extends</span> <span class="title">AbstractBuilder</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">build</span><span class="params">(String content, WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 WxMpService service)</span> </span>&#123;</span><br><span class="line">    WxMpXmlOutTextMessage m = WxMpXmlOutMessage.TEXT().content(content)</span><br><span class="line">      .fromUser(wxMessage.getToUser()).toUser(wxMessage.getFromUser())</span><br><span class="line">      .build();</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsubscribeHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  Map&lt;String, Object&gt; context, WxMpService wxMpService,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  WxSessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">    String openId = wxMessage.getFromUser();</span><br><span class="line">    <span class="comment">// 取消订阅只能返回 openId</span></span><br><span class="line">    log.info(<span class="string">&quot;取消关注用户 OPENID: &quot;</span> + openId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="客服消息"><a href="#客服消息" class="headerlink" title="客服消息"></a>客服消息</h3><p>​    当用户和公众号产生特定动作的交互时（具体动作列表请见下方说明），微信将会把消息数据推送给开发者，开发者可以在一段时间内（目前修改为48小时）调用客服接口，通过POST一个JSON数据包来发送消息给普通用户。此接口主要用于客服等有人工消息处理环节的功能，方便开发者为用户提供更加优质的服务。</p>
<p>​    目前允许的动作列表如下（公众平台会根据运营情况更新该列表，不同动作触发后，允许的客服接口下发消息条数不同，下发条数达到上限后，会遇到错误返回码，具体请见<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wiki?action=doc&id=mp1433747234&t=0.5907622380182147">返回码说明页</a>）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、用户发送信息</span><br><span class="line">2、点击自定义菜单（仅有点击推事件、扫码推事件、扫码推事件且弹出“消息接收中”提示框这3种菜单类型是会触发客服接口的）</span><br><span class="line">3、关注公众号</span><br><span class="line">4、扫描二维码</span><br><span class="line">5、支付成功</span><br><span class="line">6、用户维权</span><br></pre></td></tr></table></figure>

<p>另外，请开发者注意，本接口中所有使用到media_id的地方，现在都可以使用素材管理中的永久素材media_id了。</p>
<h4 id="Java示例-1"><a href="#Java示例-1" class="headerlink" title="Java示例"></a>Java示例</h4><p><code>me.chanjar.weixin.mp.api.WxMpKefuService#sendKefuMessage</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送客服消息，发送图片</span></span><br><span class="line">adapter.getKefuService().sendKefuMessage(WxMpKefuMessage.IMAGE()</span><br><span class="line">                                       .mediaId(mediaId).toUser(wxMessage.getFromUser()).build());</span><br></pre></td></tr></table></figure>









<h3 id="模板消息"><a href="#模板消息" class="headerlink" title="模板消息"></a>模板消息</h3><p>​    模板消息仅用于公众号向用户发送重要的服务通知，只能用于符合其要求的服务场景中，如信用卡刷卡通知，商品购买成功通知等。不支持广告等营销类消息以及其它所有可能对用户造成骚扰的消息。</p>
<p>​    在模版消息发送任务完成后，微信服务器会将是否送达成功作为通知，发送到开发者中心中填写的服务器配置地址中。</p>
<p>关于使用规则，请注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、所有服务号都可以在功能-&gt;添加功能插件处看到申请模板消息功能的入口，但只有认证后的服务号才可以申请模板消息的使用权限并获得该权限；</span><br><span class="line">2、需要选择公众账号服务所处的2个行业，每月可更改1次所选行业；</span><br><span class="line">3、在所选择行业的模板库中选用已有的模板进行调用；</span><br><span class="line">4、每个账号可以同时使用25个模板。</span><br><span class="line">5、当前每个账号的模板消息的日调用上限为10万次，单个模板没有特殊限制。【2014年11月18日将接口调用频率从默认的日1万次提升为日10万次，可在MP登录后的开发者中心查看】。当账号粉丝数超过10W/100W/1000W时，模板消息的日调用上限会相应提升，以公众号MP后台开发者中心页面中标明的数字为准。</span><br></pre></td></tr></table></figure>



<h4 id="注意点-1"><a href="#注意点-1" class="headerlink" title="注意点"></a>注意点</h4><blockquote>
<ol>
<li><strong>如果模板消息要支持跳转小程序的话，需要在公众号上添加小程序关联。<code>小程序 &gt; 小程序管理</code></strong> </li>
</ol>
</blockquote>
<h4 id="Java示例-2"><a href="#Java示例-2" class="headerlink" title="Java示例"></a>Java示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">sendTemplateMsg</span><span class="params">(WxMpTemplateMessageBO templateMessageBO)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line"></span><br><span class="line">  WxMpTemplateMessage.MiniProgram miniProgram = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (templateMessageBO.getMiniProgram() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    miniProgram = <span class="keyword">new</span> WxMpTemplateMessage.MiniProgram();</span><br><span class="line">    miniProgram.setAppid(templateMessageBO.getMiniProgram().getAppid());</span><br><span class="line">    miniProgram.setPagePath(templateMessageBO.getMiniProgram().getPagePath());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  WxMpTemplateMessage templateMessage = WxMpTemplateMessage.builder()</span><br><span class="line">    .toUser(templateMessageBO.getToUser())</span><br><span class="line">    .templateId(templateMessageBO.getTemplateId())</span><br><span class="line">    .url(templateMessageBO.getUrl())</span><br><span class="line">    .miniProgram(miniProgram)</span><br><span class="line">    .data(templateMessageBO.getData().stream().map(e -&gt; &#123;</span><br><span class="line">      WxMpTemplateData data = <span class="keyword">new</span> WxMpTemplateData();</span><br><span class="line">      data.setColor(e.getColor());</span><br><span class="line">      data.setName(e.getName());</span><br><span class="line">      data.setValue(e.getValue());</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125;).collect(Collectors.toList()))</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">  String result = wxService.getTemplateMsgService().sendTemplateMsg(templateMessage);</span><br><span class="line">  log.info(<span class="string">&quot;WxMpServiceAdapter.sendTemplateMsg result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">  <span class="keyword">return</span> StringUtils.isNotEmpty(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必填</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">touser</td>
<td align="left">是</td>
<td align="left">接收者openid</td>
</tr>
<tr>
<td align="left">template_id</td>
<td align="left">是</td>
<td align="left">模板ID</td>
</tr>
<tr>
<td align="left">url</td>
<td align="left">否</td>
<td align="left">模板跳转链接（海外帐号没有跳转能力）</td>
</tr>
<tr>
<td align="left">miniprogram</td>
<td align="left">否</td>
<td align="left">跳小程序所需数据，不需跳小程序可不用传该数据</td>
</tr>
<tr>
<td align="left">appid</td>
<td align="left">是</td>
<td align="left">所需跳转到的小程序appid（该小程序appid必须与发模板消息的公众号是绑定关联关系，暂不支持小游戏）</td>
</tr>
<tr>
<td align="left">pagepath</td>
<td align="left">否</td>
<td align="left">所需跳转到小程序的具体页面路径，支持带参数,（示例index?foo=bar），要求该小程序已发布，暂不支持小游戏</td>
</tr>
<tr>
<td align="left">data</td>
<td align="left">是</td>
<td align="left">模板数据</td>
</tr>
<tr>
<td align="left">color</td>
<td align="left">否</td>
<td align="left">模板内容字体颜色，不填默认为黑色</td>
</tr>
</tbody></table>
<p><strong>注：url和miniprogram都是非必填字段，若都不传则模板无跳转；若都传，会优先跳转至小程序。开发者可根据实际需要选择其中一种跳转方式即可。当用户的微信客户端版本不支持跳小程序时，将会跳转至url。</strong></p>
<p>在调用模板消息接口后，会返回JSON数据包。正常时的返回JSON数据包示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;errcode&quot;</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span>:<span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;msgid&quot;</span>:<span class="number">200228332</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="素材管理"><a href="#素材管理" class="headerlink" title="素材管理"></a>素材管理</h2><p>​    公众号经常有需要用到一些临时性的多媒体素材的场景，例如在使用接口特别是发送消息时，对多媒体文件、多媒体消息的获取和调用等操作，是通过media_id来进行的。素材管理接口对所有认证的订阅号和服务号开放。通过本接口，公众号可以新增临时素材（即上传临时多媒体文件）。</p>
<p>注意点：</p>
<ol>
<li><p>临时素材media_id是可复用的。</p>
</li>
<li><p><strong>媒体文件在微信后台保存时间为3天，即3天后media_id失效。</strong></p>
</li>
<li><p>上传临时素材的格式、大小限制与公众平台官网一致。</p>
<ol>
<li>图片（image）: 2M，支持PNG\JPEG\JPG\GIF格式`</li>
<li>语音（voice）：2M，播放长度不超过60s，支持AMR\MP3格式</li>
<li>视频（video）：10MB，支持MP4格式</li>
<li>缩略图（thumb）：64KB，支持JPG格式</li>
</ol>
</li>
<li><p>需使用https调用本接口。</p>
</li>
</ol>
<p><strong>参数说明</strong></p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">是否必须</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">access_token</td>
<td align="left">是</td>
<td align="left">调用接口凭证</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">是</td>
<td align="left">媒体文件类型，分别有图片（image）、语音（voice）、视频（video）和缩略图（thumb）</td>
</tr>
<tr>
<td align="left">media</td>
<td align="left">是</td>
<td align="left">form-data中媒体文件标识，有filename、filelength、content-type等信息</td>
</tr>
</tbody></table>
<p><strong>返回说明</strong></p>
<p>正确情况下的返回JSON数据包结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;type&quot;:&quot;TYPE&quot;,&quot;media_id&quot;:&quot;MEDIA_ID&quot;,&quot;created_at&quot;:123456789&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">type</td>
<td align="left">媒体文件类型，分别有图片（image）、语音（voice）、视频（video）和缩略图（thumb，主要用于视频与音乐格式的缩略图）</td>
</tr>
<tr>
<td align="left">media_id</td>
<td align="left">媒体文件上传后，获取标识</td>
</tr>
<tr>
<td align="left">created_at</td>
<td align="left">媒体文件上传时间戳</td>
</tr>
</tbody></table>
<p>错误情况下的返回JSON数据包示例如下（示例为无效媒体类型错误）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;errcode&quot;:40004,&quot;errmsg&quot;:&quot;invalid media type&quot;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Java示例-3"><a href="#Java示例-3" class="headerlink" title="Java示例"></a>Java示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getImageMediaId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  String mediaId = (String) redisTemplate.opsForValue().get(CQ_OREVER_MATERIAL);</span><br><span class="line">  <span class="comment">// 获取声音或者图片永久素材</span></span><br><span class="line">  <span class="keyword">try</span> (InputStream inputStream = adapter.getMaterialService().materialImageOrVoiceDownload(mediaId)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> mediaId;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot; getMaterialService.materialImageOrVoiceDownload error&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新增非图文永久素材</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    WxMpMaterial material = createWxMpMaterial();</span><br><span class="line">    WxMpMaterialUploadResult result = adapter.getMaterialService()</span><br><span class="line">      .materialFileUpload(<span class="string">&quot;image&quot;</span>, material);</span><br><span class="line">    <span class="keyword">return</span> result.getMediaId();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot; getMaterialService.materialFileUpload error&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WxMpMaterial <span class="title">createWxMpMaterial</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  WxMpMaterial material = <span class="keyword">new</span> WxMpMaterial();</span><br><span class="line">  material.setName(<span class="string">&quot;微信小程序二维码&quot;</span>);</span><br><span class="line">  material.setFile(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;qrcode_for_service.jpg&quot;</span>).getFile());</span><br><span class="line">  <span class="keyword">return</span> material;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>me.chanjar.weixin.mp.api.WxMpMaterialService#materialFileBatchGet</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分页获取其他媒体素材列表</span></span><br><span class="line"><span class="function">WxMpMaterialFileBatchGetResult <span class="title">materialFileBatchGet</span><span class="params">(String type, <span class="keyword">int</span> offset, <span class="keyword">int</span> count)</span> <span class="keyword">throws</span> WxErrorException</span>;</span><br></pre></td></tr></table></figure>



<p>​    </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/06/03/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" data-id="ckvtb0r5a000bf2f65ug16ypb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WxJava-%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">WxJava 公众号</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用WxJava开发微信小程序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/31/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="article-date">
  <time datetime="2019-05-31T09:08:18.000Z" itemprop="datePublished">2019-05-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/31/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">使用WxJava开发微信小程序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="小程序服务配置"><a href="#小程序服务配置" class="headerlink" title="小程序服务配置"></a>小程序服务配置</h2><p>利用 weixin-java-miniapp 配置 appId 和 secret 。</p>
<ol>
<li><p>添加<code>pom.xml</code>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-miniapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>添加<code>application.yml</code>配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">debug</span>: <span class="string">false</span></span><br><span class="line"><span class="attr">logging</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">level</span>:<span class="string"></span></span><br><span class="line">    <span class="meta">org.springframework.web</span>: <span class="string">info</span></span><br><span class="line">    <span class="meta">cn.binarywang.wx.miniapp</span>: <span class="string">info</span></span><br><span class="line">    <span class="meta">me.chanjar.weixin</span>: <span class="string">info</span></span><br><span class="line"><span class="attr">wx</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">miniapp</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">configs</span>:<span class="string"></span></span><br><span class="line">      <span class="meta">-</span> <span class="string">appid: appid</span></span><br><span class="line">        <span class="attr">secret</span>: <span class="string">appidsecret</span></span><br><span class="line">        <span class="attr">token</span>: <span class="string"># cqtest  (测试环境)</span></span><br><span class="line">        <span class="attr">aesKey</span>: <span class="string"># RGAioK00rOP3TKnNVMVtBvCarimzvq4AFqltvAT0TiF </span></span><br><span class="line">        <span class="attr">msgDataFormat</span>: <span class="string">JSON</span></span><br></pre></td></tr></table></figure></li>
<li><p>Java配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;wx.miniapp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMaProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Config&gt; configs;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置微信小程序的appid</span></span><br><span class="line">        <span class="keyword">private</span> String appid;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置微信小程序的Secret</span></span><br><span class="line">        <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置微信小程序消息服务器配置的token</span></span><br><span class="line">        <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置微信小程序消息服务器配置的EncodingAESKey</span></span><br><span class="line">        <span class="keyword">private</span> String aesKey;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//消息格式，XML或者JSON</span></span><br><span class="line">        <span class="keyword">private</span> String msgDataFormat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"> <span class="meta">@EnableConfigurationProperties(WxMaProperties.class)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMaServiceConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> WxMaProperties properties;</span><br><span class="line">   <span class="comment">//按照appid分wxMaService</span></span><br><span class="line">   <span class="keyword">private</span>   Map&lt;String, WxMaService&gt; maServices = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     maServices = <span class="keyword">this</span>.properties.getConfigs().stream()</span><br><span class="line">       .map(a -&gt; &#123;</span><br><span class="line">         WxMaInMemoryConfig config = <span class="keyword">new</span> WxMaInMemoryConfig();</span><br><span class="line">         config.setAppid(a.getAppid());</span><br><span class="line">         config.setSecret(a.getSecret());</span><br><span class="line">         config.setToken(a.getToken());</span><br><span class="line">         config.setAesKey(a.getAesKey());</span><br><span class="line">         config.setMsgDataFormat(a.getMsgDataFormat());</span><br><span class="line">         WxMaService service = <span class="keyword">new</span> WxMaServiceImpl();</span><br><span class="line">         service.setWxMaConfig(config);</span><br><span class="line">         <span class="keyword">return</span> service;</span><br><span class="line">       &#125;).collect(Collectors.toMap(s -&gt; s.getWxMaConfig().getAppid(), a -&gt; a));   </span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> WxMaService <span class="title">getMaService</span><span class="params">(String appid)</span> </span>&#123;</span><br><span class="line">     WxMaService wxService = maServices.get(appid);</span><br><span class="line">     <span class="keyword">if</span> (wxService == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">&quot;未找到对应appid=[%s]的配置，请核实！&quot;</span>, appid));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> wxService;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><blockquote>
<ol>
<li>使用之前，需要保证使用 JRE/JDK 8u151 之后的版本，或者替换两个jar，否则加密时会出现 <code>java.security.InvalidKeyException: Illegal key size</code> 的问题。<a target="_blank" rel="noopener" href="https://github.com/Wechat-Group/WxJava/wiki/%E5%8A%A0%E8%A7%A3%E5%AF%86%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%8A%9E%E6%B3%95">详见</a></li>
</ol>
</blockquote>
<h2 id="access-token"><a href="#access-token" class="headerlink" title="access_token"></a>access_token</h2><p>​    <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">接口调用凭证</a>，调用绝大多数后台接口时都需使用 access_token，开发者需要进行妥善保存。</p>
<p>​    <code>weixin-java-miniapp </code>对 access_token 做了相应的封装，每次调用接口的时候都会主动获取 access_token 。</p>
<p>​    <code>cn.binarywang.wx.miniapp.api.impl.WxMaServiceImpl#executeInternal</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T, E&gt; <span class="function">T <span class="title">executeInternal</span><span class="params">(RequestExecutor&lt;T, E&gt; executor, String uri, E data)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">if</span> (uri.contains(<span class="string">&quot;access_token=&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;uri参数中不允许有access_token: &quot;</span> + uri);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// 获取 access_token</span></span><br><span class="line">  String accessToken = getAccessToken(<span class="keyword">false</span>);</span><br><span class="line">  String uriWithAccessToken = uri + (uri.contains(<span class="string">&quot;?&quot;</span>) ? <span class="string">&quot;&amp;&quot;</span> : <span class="string">&quot;?&quot;</span>) + <span class="string">&quot;access_token=&quot;</span> + accessToken;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    T result = executor.execute(uriWithAccessToken, data);</span><br><span class="line">    log.debug(<span class="string">&quot;\n【请求地址】: &#123;&#125;\n【请求参数】：&#123;&#125;\n【响应数据】：&#123;&#125;&quot;</span>, uriWithAccessToken, dataForLog, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAccessToken</span><span class="params">(<span class="keyword">boolean</span> forceRefresh)</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">  Lock lock = <span class="keyword">this</span>.getWxMaConfig().getAccessTokenLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="comment">// 判断 access_token 是否超时</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getWxMaConfig().isAccessTokenExpired() || forceRefresh) &#123;</span><br><span class="line">      String url = String.format(WxMaService.GET_ACCESS_TOKEN_URL, <span class="keyword">this</span>.getWxMaConfig().getAppid(),</span><br><span class="line">                                 <span class="keyword">this</span>.getWxMaConfig().getSecret());</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getRequestHttpProxy() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          RequestConfig config = RequestConfig.custom().setProxy(<span class="keyword">this</span>.getRequestHttpProxy()).build();</span><br><span class="line">          httpGet.setConfig(config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> (CloseableHttpResponse response = getRequestHttpClient().execute(httpGet)) &#123;</span><br><span class="line">          String resultContent = <span class="keyword">new</span> BasicResponseHandler().handleResponse(response);</span><br><span class="line">          WxError error = WxError.fromJson(resultContent);</span><br><span class="line">          <span class="keyword">if</span> (error.getErrorCode() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WxErrorException(error);</span><br><span class="line">          &#125;</span><br><span class="line">          WxAccessToken accessToken = WxAccessToken.fromJson(resultContent);</span><br><span class="line">          <span class="comment">// 更新新的 access_token</span></span><br><span class="line">          <span class="keyword">this</span>.getWxMaConfig().updateAccessToken(accessToken.getAccessToken(),</span><br><span class="line">                                                 accessToken.getExpiresIn());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          httpGet.releaseConnection();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getWxMaConfig().getAccessToken();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h3><p>​    <code>weixin-java-miniapp</code> 中使用 <code>cn.binarywang.wx.miniapp.config.WxMaConfig</code> 记录着 <code>access_token</code> ，在 <code>access_token</code> 超时之前都可以直接从 <code>WxMaConfig</code> 中获取。需要注意的是，每次请求的<code>access_token</code>都是不一样的，即使在超时时间内，获取到的也是新的 access_token 。</p>
<p>​    <code>weixin-java-miniapp</code> 中 <code>cn.binarywang.wx.miniapp.config.WxMaConfig</code> 的实现类只有 <code>cn.binarywang.wx.miniapp.config.WxMaInMemoryConfig</code>类，是基于本地内存存储的，**在生产环境多机器环境中应该将这些配置持久化到一个独立的地方(可以使用Redis)**。</p>
<p>​    比如，继承 <code>WxMaInMemoryConfig</code> ，利用 Redis 重写 <code>getAccessToken</code> 、<code>updateAccessToken</code> 等方法。然后在初始化 <code>WxMaService</code> 的时候使用自定义的 <code>WxMaConfig</code>。</p>
<h2 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h2><h3 id="小程序登录"><a href="#小程序登录" class="headerlink" title="小程序登录"></a>小程序登录</h3><p>微信小程序提供的登录流程时序</p>
<p><img src="https://res.wx.qq.com/wxdoc/dist/assets/img/api-login.2fcc9f35.jpg" alt="img"></p>
<p>说明：</p>
<ol>
<li><strong>微信小程序</strong> 调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login()</a> 获取 <strong>临时登录凭证code</strong> ，并回传到开发者服务器。</li>
<li><strong>开发者服务器</strong> 调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html">auth.code2Session</a> 接口，换取 <strong>用户唯一标识 OpenID</strong> 和 <strong>会话密钥 session_key</strong>。</li>
</ol>
<p>之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。</p>
<h4 id="注意-2"><a href="#注意-2" class="headerlink" title="注意"></a>注意</h4><ol>
<li>会话密钥 <code>session_key</code> 是对用户数据进行 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html">加密签名</a> 的密钥。为了应用自身的数据安全，开发者服务器<strong>不应该把会话密钥下发到小程序，也不应该对外提供这个密钥</strong>。</li>
<li>临时登录凭证 code 只能使用一次</li>
</ol>
<h3 id="Java后台登陆"><a href="#Java后台登陆" class="headerlink" title="Java后台登陆"></a>Java后台登陆</h3><p>​    从上面的登陆流程可以看见，开发者服务器在小程序和微信服务器之间充当了中专、代理的功能。</p>
<p>​    在这个登陆流程中，起到了置换登陆状态的功能。</p>
<p>​    这里利用了 <code>weixin-java-miniapp</code> 实现微信小程序接口的调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.github.binarywang&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;weixin-java-miniapp&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;	</span><br></pre></td></tr></table></figure>

<p>​    获取用户登陆后的session信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> WxMaService wxService = wxMaServiceConfiguration.getMaService(appId);  </span><br><span class="line">WxMaJscode2SessionResult session = wxService.getUserService().getSessionInfo(code);</span><br></pre></td></tr></table></figure>

<p>​    然后就可以使用自定义的登陆状态，封装微信返回的 session 信息。</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><h3 id="模板消息"><a href="#模板消息" class="headerlink" title="模板消息"></a>模板消息</h3><p>​    <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/template-message.html">微信官方文档·小程序·开放能力·消息·模板消息</a></p>
<ul>
<li>模板推送位置：服务通知</li>
<li>模板下发条件：用户本人在微信体系内与页面有交互行为后触发<ul>
<li>支付：当用户 在小程序内完成过支付行为，可允许开发者向用户在7天内推送有限条数的模板消息（1次支付可下发3条，多次支付下发条数独立，互相不影响）</li>
<li>提交表单：当用户在小程序内发生过提交表单行为且该表单声明为要发模板消息的，开发者需要向用户提供服务时，可允许开发者向用户在7天内推送有限条数的模板消息（1次提交表单可下发1条，多次提交下发条数独立，相互不影响）</li>
</ul>
</li>
<li>模板跳转能力：点击查看详情仅能跳转下发模板的该帐号的各个页面</li>
</ul>
<h4 id="注意-3"><a href="#注意-3" class="headerlink" title="注意"></a>注意</h4><ol>
<li>发送模板消息之前需要有相关的模板，获取该模板ID</li>
<li>发送模板消息的时候，还需要前端收集的 form_id (用户提交表单下产生的。也就是先收集用户产生的 form_id ，然后再利用 form_id 发送模板消息。form_id 的有限期是7天。</li>
</ol>
<h3 id="客服消息"><a href="#客服消息" class="headerlink" title="客服消息"></a>客服消息</h3><p>​    <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/customer-message/customer-message.html">微信官方文档·小程序·开放能力·消息·客服消息</a></p>
<p>​    在页面使用客服消息</p>
<p>​    需要将 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html">button</a> 组件 <code>open-type</code> 的值设置为 <code>contact</code>，当用户点击后就会进入客服会话，如果用户在会话中点击了小程序消息，则会返回到小程序，开发者可以通过 <code>bindcontact</code> 事件回调获取到用户所点消息的页面路径 <code>path</code> 和对应的参数 <code>query</code>。</p>
<p>​    后台接入消息服务</p>
<p>​    用户向小程序客服发送消息、或者进入会话等情况时，开发者填写的服务器配置 URL （如果使用的是云开发，则是配置的云函数）将得到微信服务器推送过来的消息和事件，开发者可以依据自身业务逻辑进行响应。接入和使用方式请参考<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/server-ability/message-push.html">消息推送</a>。</p>
<p>​    发送消息</p>
<p>​    当用户和小程序客服产生特定动作的交互时（具体动作列表请见下方说明），微信将会把消息数据推送给开发者，开发者可以在一段时间内（目前为 48 小时）调用客服接口，通过调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/customer-message/customerServiceMessage.send.html">发送客服消息接口</a> 来发送消息给普通用户。此接口主要用于客服等有人工消息处理环节的功能，方便开发者为用户提供更加优质的服务。</p>
<p>目前允许的动作列表如下，不同动作触发后，允许的客服接口下发消息条数和下发时限不同。</p>
<table>
<thead>
<tr>
<th align="left">用户动作</th>
<th align="left">允许下发条数限制</th>
<th align="left">下发时限</th>
</tr>
</thead>
<tbody><tr>
<td align="left">用户发送消息</td>
<td align="left">5 条</td>
<td align="left">48 小时</td>
</tr>
</tbody></table>
<h4 id="注意-4"><a href="#注意-4" class="headerlink" title="注意"></a>注意</h4><ol>
<li>利用客服接口，可以针对一个请求，恢复多条内容。比如，用户发送了一个1，客服可以回复图片和文字两条消息。</li>
</ol>
<h3 id="Java后台消息"><a href="#Java后台消息" class="headerlink" title="Java后台消息"></a>Java后台消息</h3><h4 id="发送模板消息"><a href="#发送模板消息" class="headerlink" title="发送模板消息"></a>发送模板消息</h4><p> <code>cn.binarywang.wx.miniapp.api.WxMaMsgService#sendTemplateMsg</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> WxMaService wxService = wxMaServiceConfiguration.getMaService(getAppId());</span><br><span class="line">WxMaMsgService maMsgService = wxService.getMsgService();</span><br><span class="line">WxMaTemplateMessage message = WxMaTemplateMessage.builder()</span><br><span class="line">  .toUser(messageBO.getToUser())</span><br><span class="line">  .templateId(messageBO.getTemplateId())</span><br><span class="line">  .formId(messageBO.getFormId())</span><br><span class="line">  .page(messageBO.getPage())</span><br><span class="line">  .color(messageBO.getColor())</span><br><span class="line">  .emphasisKeyword(messageBO.getEmphasisKeyword())</span><br><span class="line">  .data(messageBO.getData().stream()</span><br><span class="line">        .map(TemplateDataAssembler::buildWxMaTemplateMessage)</span><br><span class="line">        .collect(Collectors.toList()))</span><br><span class="line">  .build();</span><br><span class="line"></span><br><span class="line">maMsgService.sendTemplateMsg(message);</span><br></pre></td></tr></table></figure>



<h4 id="发送客服消息"><a href="#发送客服消息" class="headerlink" title="发送客服消息"></a>发送客服消息</h4><p>​    用户发送客服消息，开发者需要填写服务器配置。</p>
<p><strong>步骤一：填写服务器配置</strong></p>
<p>登录<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">小程序后台</a>后，在「开发」-「开发设置」-「消息推送」中，管理员扫码启用消息服务，填写服务器地址（URL）、令牌（Token） 和 消息加密密钥（EncodingAESKey）等信息。</p>
<ul>
<li>URL: 开发者用来接收微信消息和事件的接口 URL。开发者所填写的URL 必须以 http:// 或 https:// 开头，分别支持 80 端口和 443 端口。</li>
<li>Token: 可由开发者可以任意填写，用作生成签名（该 Token 会和接口 URL 中包含的 Token 进行比对，从而验证安全性）。</li>
<li>EncodingAESKey: 由开发者手动填写或随机生成，将用作消息体加解密密钥。</li>
</ul>
<p>同时，开发者可选择消息加解密方式：明文模式（默认）、兼容模式和安全模式。可以选择消息数据格式：XML 格式（默认）或 JSON 格式。</p>
<p><img src="https://res.wx.qq.com/wxdoc/dist/assets/img/callback_help.ae01307b.png" alt="å¡«åæå¡å¨éç½®"></p>
<p>模式的选择与服务器配置在提交后都会立即生效，请开发者谨慎填写及选择。切换加密方式和数据格式需要提前配置好相关代码，详情请参考 <a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419318479&token=&lang=zh_CN">消息加解密说明</a>。</p>
<p><strong>步骤二：验证消息的确来自微信服务器</strong></p>
<p>开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带参数如下表所示：</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">signature</td>
<td align="left">微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。</td>
</tr>
<tr>
<td align="left">timestamp</td>
<td align="left">时间戳</td>
</tr>
<tr>
<td align="left">nonce</td>
<td align="left">随机数</td>
</tr>
<tr>
<td align="left">echostr</td>
<td align="left">随机字符串</td>
</tr>
</tbody></table>
<p>开发者通过检验 signature 对请求进行校验（下面有校验方式）。若确认此次 GET 请求来自微信服务器，请原样返回 echostr 参数内容，则接入生效，成为开发者成功，否则接入失败。加密/校验流程如下：</p>
<ol>
<li>将token、timestamp、nonce三个参数进行字典序排序</li>
<li>将三个参数字符串拼接成一个字符串进行sha1加密</li>
<li>开发者获得加密后的字符串可与signature对比，标识该请求来源于微信</li>
</ol>
<p>验证URL有效性成功后即接入生效，成为开发者。</p>
<p>Java 实例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;xxx/&#123;appid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMaPortalController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  WxMaServiceConfiguration wxMaServiceConfiguration;</span><br><span class="line">  <span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">authGet</span><span class="params">(<span class="meta">@PathVariable</span> String appid,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;signature&quot;, required = false)</span> String signature,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;timestamp&quot;, required = false)</span> String timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;nonce&quot;, required = false)</span> String nonce,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@RequestParam(name = &quot;echostr&quot;, required = false)</span> String echostr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isAnyBlank(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;请求参数非法，请核实!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> WxMaService wxService = wxMaServiceConfiguration.getMaService(appid);</span><br><span class="line">    <span class="keyword">if</span> (wxService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">      <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第三步：接收消息和事件</strong></p>
<p>当某些特定的用户操作引发事件推送时（如用户向小程序客服发送消息、或者进入会话等情况），微信服务器会将消息（或事件）的数据包以 POST 请求发送到开发者配置的 URL，开发者可以依据自身业务逻辑进行响应。</p>
<p>微信服务器在将用户的消息发给开发者服务器地址后，微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。如果在调试中，发现用户无法收到响应的消息，可以检查是否消息处理超时。关于重试的消息排重，有 msgid 的消息推荐使用 msgid 排重。事件类型消息推荐使用 FromUserName + CreateTime 排重。</p>
<p>服务器收到请求必须做出下述回复，这样微信服务器才不会对此作任何处理，并且不会发起重试，否则，将出现严重的错误提示。详见下面说明：</p>
<ol>
<li>直接回复success（推荐方式）</li>
<li>直接回复空串（指字节长度为0的空字符串，而不是结构体中content字段的内容为空）</li>
<li>若接口文档有指定返回内容，应按文档说明返回</li>
</ol>
<p>对于客服消息，一旦遇到以下情况，微信会在小程序会话中向用户下发系统提示“该小程序客服暂时无法提供服务，请稍后再试”：</p>
<ol>
<li>开发者在5秒内未回复任何内容</li>
<li>开发者回复了异常数据</li>
</ol>
<p>如果开发者希望增强安全性，可以在开发者中心处开启消息加密，这样，用户发给小程序的消息以及小程序被动回复用户消息都会继续加密，详见<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419318479&token=&lang=zh_CN">消息加解密说明</a>。</p>
<p>Java 实例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  Map&lt;String, WxMaService&gt; maServices = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span>  Map&lt;String, WxMaMessageRouter&gt; routers = <span class="keyword">new</span> HashMap&lt;&gt;() ;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] imageBuffer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  maServices = <span class="keyword">this</span>.properties.getConfigs().stream()</span><br><span class="line">    .map(a -&gt; &#123;</span><br><span class="line">      WxMaInMemoryConfig config = <span class="keyword">new</span> WxMaInMemoryConfig();</span><br><span class="line">      config.setAppid(a.getAppid());</span><br><span class="line">      config.setSecret(a.getSecret());</span><br><span class="line">      config.setToken(a.getToken());</span><br><span class="line">      config.setAesKey(a.getAesKey());</span><br><span class="line">      config.setMsgDataFormat(a.getMsgDataFormat());</span><br><span class="line">      WxMaService service = <span class="keyword">new</span> WxMaServiceImpl();</span><br><span class="line">      service.setWxMaConfig(config);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置事件处理器</span></span><br><span class="line">      routers.put(a.getAppid(), <span class="keyword">this</span>.newRouter(service));</span><br><span class="line">      <span class="keyword">return</span> service;</span><br><span class="line">    &#125;).collect(Collectors.toMap(s -&gt; s.getWxMaConfig().getAppid(), a -&gt; a));   </span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span>(InputStream is = <span class="keyword">new</span> ClassPathResource(<span class="string">&quot;qrcode_for_gh_ac1de8498046_258.jpg&quot;</span>).getInputStream())&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] byteArray = IOUtils.toByteArray(is);</span><br><span class="line">    imageBuffer=byteArray;</span><br><span class="line">  &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> WxMaMessageRouter <span class="title">newRouter</span><span class="params">(WxMaService service)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> WxMaMessageRouter router = <span class="keyword">new</span> WxMaMessageRouter(service);</span><br><span class="line">  router.rule().handler(logHandler).next()</span><br><span class="line">    .rule().async(<span class="keyword">false</span>).content(<span class="string">&quot;1&quot;</span>).handler(picHandler).end();</span><br><span class="line">  <span class="keyword">return</span> router;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WxMaMessageHandler logHandler = (wxMessage, context, service, sessionManager) -&gt; &#123;</span><br><span class="line">  log.info(<span class="string">&quot;收到消息：&quot;</span> + wxMessage.toString());</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WxMaMessageHandler picHandler = (wxMessage, context, service, sessionManager) -&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> (ByteArrayInputStream bais=<span class="keyword">new</span> ByteArrayInputStream(imageBuffer))&#123;</span><br><span class="line">    InputStream is = bais;</span><br><span class="line">    WxMediaUploadResult uploadResult = service.getMediaService()</span><br><span class="line">      .uploadMedia(<span class="string">&quot;image&quot;</span>, <span class="string">&quot;jpg&quot;</span>, is);</span><br><span class="line">    service.getMsgService().sendKefuMsg(</span><br><span class="line">      WxMaKefuMessage</span><br><span class="line">      .newImageBuilder()</span><br><span class="line">      .mediaId(uploadResult.getMediaId())</span><br><span class="line">      .toUser(wxMessage.getFromUser())</span><br><span class="line">      .build());</span><br><span class="line"></span><br><span class="line">    service.getMsgService().sendKefuMsg(WxMaKefuMessage.newTextBuilder().content(KEFU_TEXT)</span><br><span class="line">                                        .toUser(wxMessage.getFromUser()).build());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;WxMaMessageHandler error:&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(produces = &quot;application/xml; charset=UTF-8&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">post</span><span class="params">(<span class="meta">@PathVariable</span> String appid,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestBody</span> String requestBody,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;msg_signature&quot;)</span> String msgSignature,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;encrypt_type&quot;)</span> String encryptType,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce)</span> </span>&#123;</span><br><span class="line">  log.info(<span class="string">&quot;\n接收微信请求：[msg_signature=[&#123;&#125;], encrypt_type=[&#123;&#125;], signature=[&#123;&#125;],&quot;</span> +</span><br><span class="line">           <span class="string">&quot; timestamp=[&#123;&#125;], nonce=[&#123;&#125;], requestBody=[\n&#123;&#125;\n] &quot;</span>,</span><br><span class="line">           msgSignature, encryptType, signature, timestamp, nonce, requestBody);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> WxMaService wxService = wxMaServiceConfiguration.getMaService(appid);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> isJson = Objects.equals(wxService.getWxMaConfig().getMsgDataFormat(),</span><br><span class="line">                                        WxMaConstants.MsgDataFormat.JSON);</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(encryptType)) &#123;</span><br><span class="line">    <span class="comment">// 明文传输的消息</span></span><br><span class="line">    WxMaMessage inMessage;</span><br><span class="line">    <span class="keyword">if</span> (isJson) &#123;</span><br><span class="line">      inMessage = WxMaMessage.fromJson(requestBody);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//xml</span></span><br><span class="line">      inMessage = WxMaMessage.fromXml(requestBody);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.route(inMessage, appid);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;aes&quot;</span>.equals(encryptType)) &#123;</span><br><span class="line">    <span class="comment">// 是aes加密的消息</span></span><br><span class="line">    WxMaMessage inMessage;</span><br><span class="line">    <span class="keyword">if</span> (isJson) &#123;</span><br><span class="line">      inMessage = WxMaMessage.fromEncryptedJson(requestBody, wxService.getWxMaConfig());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//xml</span></span><br><span class="line">      inMessage = WxMaMessage.fromEncryptedXml(requestBody, wxService.getWxMaConfig(),</span><br><span class="line">                                               timestamp, nonce, msgSignature);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.route(inMessage, appid);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;不可识别的加密类型：&quot;</span> + encryptType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">route</span><span class="params">(WxMaMessage message, String appid)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    wxMaServiceConfiguration.getRouters().get(appid).route(message);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(e.getMessage(), e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
























      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/05/31/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" data-id="ckvtb0r5d000ff2f63aflfbho" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WxJava-%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">WxJava 小程序</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="java-Resource" class="article article-type-java" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/22/Resource/" class="article-date">
  <time datetime="2019-05-22T07:35:55.000Z" itemprop="datePublished">2019-05-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/22/Resource/">Resource</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><h3 id="事件描述"><a href="#事件描述" class="headerlink" title="事件描述"></a>事件描述</h3><p>​    开发环境：Mac， dea，Spring boot 1.5.3.RELEASE</p>
<p>​    在开发微信小程序客服消息的时候，需要针对context为1的内容回复一张图片。</p>
<p>​    因为，微信小程序相关的配置都是写在Common模板下的，所以就把图片放在Common模块下的resource中。</p>
<p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1g3a6opuyvvj30bs07gmxk.jpg" alt="image-20190522164029948"></p>
<p>​        IDEA中，使用以下代码都能拿到图片对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream is = ClassLoader.getSystemResourceAsStream(<span class="string">&quot;qrcode_for_gh_ac1de8498046_258.jpg&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream is = WxMaServiceConfiguration.class.getResourceAsStream(<span class="string">&quot;/qrcode_for_gh_ac1de8498046_258.jpg&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>​    当项目部署到服务器上的tomcat的时候，以上两个方法就都找不到图片对象了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-webroot</span><br><span class="line">	-WEB-INF</span><br><span class="line">		-classes</span><br><span class="line">			-application.properties</span><br><span class="line">			......</span><br><span class="line">		-lib</span><br><span class="line">			-xxx-common-1.0.0-SNAPSHOT.jar(jarz中包含了图片)</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    为什么开发环境可以加载，部署到服务器上就加载不了了呢？</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="ClassLoader-getSystemResourceAsStream"><a href="#ClassLoader-getSystemResourceAsStream" class="headerlink" title="ClassLoader.getSystemResourceAsStream"></a>ClassLoader.getSystemResourceAsStream</h3><h4 id="java-lang-ClassLoader"><a href="#java-lang-ClassLoader" class="headerlink" title="java.lang.ClassLoader"></a>java.lang.ClassLoader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InputStream <span class="title">getSystemResourceAsStream</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    URL url = getSystemResource(name);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> url != <span class="keyword">null</span> ? url.openStream() : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title">getSystemResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    ClassLoader system = getSystemClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (system == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getBootstrapResource(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> system.getResource(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CallerSensitive</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    initSystemClassLoader();</span><br><span class="line">    <span class="keyword">if</span> (scl == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">      checkClassLoaderPermission(scl, Reflection.getCallerClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sclSet) &#123;</span><br><span class="line">      <span class="keyword">if</span> (scl != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;recursive invocation&quot;</span>);</span><br><span class="line">      sun.misc.Launcher l = sun.misc.Launcher.getLauncher();</span><br><span class="line">      <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Throwable oops = <span class="keyword">null</span>;</span><br><span class="line">        scl = l.getClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          scl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> SystemClassLoaderAction(scl));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">          oops = pae.getCause();</span><br><span class="line">          <span class="keyword">if</span> (oops <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">            oops = oops.getCause();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (oops != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (oops <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (Error) oops;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// wrap the exception</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(oops);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      sclSet = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> URL <span class="title">getBootstrapResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    URLClassPath ucp = getBootstrapClassPath();</span><br><span class="line">    Resource res = ucp.getResource(name);</span><br><span class="line">    <span class="keyword">return</span> res != <span class="keyword">null</span> ? res.getURL() : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> URLClassPath <span class="title">getBootstrapClassPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Bootstrap 从 Launcher 的方法中初始化</span></span><br><span class="line">    <span class="keyword">return</span> sun.misc.Launcher.getBootstrapClassPath();</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="sun-misc-Launcher"><a href="#sun-misc-Launcher" class="headerlink" title="sun.misc.Launcher"></a>sun.misc.Launcher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> URLStreamHandlerFactory factory = <span class="keyword">new</span> Launcher.Factory();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Launcher launcher = <span class="keyword">new</span> Launcher();</span><br><span class="line">  <span class="comment">// &#123;$JAVA_HOME&#125;/jre/lib 和 &#123;$JAVA_HOME&#125;/jre/classes，Bootstrap ClassLoader的路径</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String bootClassPath = System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>);</span><br><span class="line">  <span class="keyword">private</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Launcher.ExtClassLoader var1;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ExtClassLoader </span></span><br><span class="line">      var1 = Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var10) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create extension class loader&quot;</span>, var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// AppClassLoader</span></span><br><span class="line">      <span class="keyword">this</span>.loader = Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create application class loader&quot;</span>, var9);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.currentThread().setContextClassLoader(<span class="keyword">this</span>.loader);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URLClassPath <span class="title">getBootstrapClassPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Launcher.BootClassPathHolder.bcp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BootClassPathHolder</span> </span>&#123;</span><br><span class="line">      <span class="comment">// URLClassPath</span></span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">final</span> URLClassPath bcp;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">BootClassPathHolder</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">static</span> &#123;</span><br><span class="line">        URL[] var0;</span><br><span class="line">        <span class="keyword">if</span> (Launcher.bootClassPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">          var0 = (URL[])AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;URL[]&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> URL[] run() &#123;</span><br><span class="line">              File[] var1 = Launcher.getClassPath(Launcher.bootClassPath);</span><br><span class="line">              <span class="keyword">int</span> var2 = var1.length;</span><br><span class="line">              HashSet var3 = <span class="keyword">new</span> HashSet();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var2; ++var4) &#123;</span><br><span class="line">                File var5 = var1[var4];</span><br><span class="line">                <span class="keyword">if</span> (!var5.isDirectory()) &#123;</span><br><span class="line">                  var5 = var5.getParentFile();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (var5 != <span class="keyword">null</span> &amp;&amp; var3.add(var5)) &#123;</span><br><span class="line">                  MetaIndex.registerDirectory(var5);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> Launcher.pathToURLs(var1);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          var0 = <span class="keyword">new</span> URL[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bcp = <span class="keyword">new</span> URLClassPath(var0, Launcher.factory, (AccessControlContext)<span class="keyword">null</span>);</span><br><span class="line">        bcp.initLookupCache((ClassLoader)<span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AppClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getAppClassLoader</span><span class="params">(<span class="keyword">final</span> ClassLoader var0)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> String var1 = System.getProperty(<span class="string">&quot;java.class.path&quot;</span>);</span><br><span class="line">      <span class="keyword">final</span> File[] var2 = var1 == <span class="keyword">null</span> ? <span class="keyword">new</span> File[<span class="number">0</span>] : Launcher.getClassPath(var1);</span><br><span class="line">      <span class="keyword">return</span> (ClassLoader)AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Launcher.AppClassLoader&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> Launcher.<span class="function">AppClassLoader <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          URL[] var1x = var1 == <span class="keyword">null</span> ? <span class="keyword">new</span> URL[<span class="number">0</span>] : Launcher.pathToURLs(var2);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> Launcher.AppClassLoader(var1x, var0);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面代码可以知道，<code>java.lang.ClassLoader#getSystemClassLoader</code> 获取是 <code>sun.misc.Launcher.AppClassLoader</code>。</p>
<p><code>java.lang.ClassLoader#getBootstrapResource</code> 方法，返回的是 <code>sun.misc.URLClassPath</code> 对象。这个对象是在rt.jar包中的。</p>
<p>​    </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/briblue/article/details/54973413">https://blog.csdn.net/briblue/article/details/54973413</a>  详细看下 这里的classloader内容。</p>
<h3 id="XXX-class-getResourceAsStream"><a href="#XXX-class-getResourceAsStream" class="headerlink" title="XXX.class.getResourceAsStream"></a>XXX.class.getResourceAsStream</h3><p>WebappClassLoader  可以加载 jar中的资源文件</p>
<p>WebappClassLoader<br>  context:<br>  delegate: false<br>  repositories:<br>    /WEB-INF/classes/<br>———-&gt; Parent Classloader:<br>org.apache.catalina.loader.StandardClassLoader@2145b572</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader.getSystemClassLoader().getClass()</span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">sun</span>.<span class="title">misc</span>.<span class="title">Launcher</span>$<span class="title">AppClassLoader</span></span></span><br></pre></td></tr></table></figure>






      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/05/22/Resource/" data-id="ckvtb0r4w0001f2f67q1a151d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-Resource/" rel="tag">Java Resource</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="spring-Async" class="article article-type-spring" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/13/Async/" class="article-date">
  <time datetime="2019-05-13T01:16:48.000Z" itemprop="datePublished">2019-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/13/Async/">Async</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Async-使用"><a href="#Async-使用" class="headerlink" title="Async 使用"></a>Async 使用</h2><p>​    <code>@Async</code>的使用非常简单。只需在配置类上加上 <code>@EnableAsync</code> 就可以直接使用。</p>
<p>​    如果需要指定线程池执行，需要在配置类中指定线程池别名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncExecutorQualifiedByNameConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Qualifier(&quot;userAccountCreateEventAsyncThreadPool&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Executor <span class="title">userAccountCreateEventAsyncThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//线程池</span></span><br><span class="line">    ThreadPoolExecutor poolExecutor = ThreadPoolGenerator.newCallerRunSyncQueuePool(<span class="string">&quot;userAccountCreateEventAsyncThreadPool&quot;</span>, <span class="number">20</span>, <span class="number">50</span>);</span><br><span class="line">    <span class="keyword">return</span> poolExecutor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定线程池异步执行</span></span><br><span class="line"><span class="meta">@Async(&quot;userAccountCreateEventAsyncThreadPool&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(UserAccountCreateEvent event)</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="实现分析"><a href="#实现分析" class="headerlink" title="实现分析"></a>实现分析</h2><p>​    一般情况下都是这些<code>@EnableXXX</code>注解里面有一个<code>@Import</code>注解，然后这个<code>@Import</code>注解会导入一个类，这个被导入的类一般是个配置类（类上面有<code>@Configuration</code>注解），然后里面配置了需要用到的类的Bean。</p>
<p>​    <code>org.springframework.scheduling.annotation.EnableAsync</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(AsyncConfigurationSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAsync &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <code>org.springframework.scheduling.annotation.AsyncConfigurationSelector</code>:</p>
<p>​    该类实现了<code>ImportSelector</code>接口，最终会调用到<code>AsyncConfigurationSelector</code>实现的selectImports方法，这个方法可能返回 <code>ProxyAsyncConfiguration</code> 类的全限定名或者 <code>org.springframework.scheduling.aspectj.AspectJAsyncConfiguration </code> 或者<code>null</code>，如果不是<code>null</code>的话，后面会解析这些类上面的注解（两个类都是配置类，即类上面有<code>@Configuration注解</code>），然后将读取到的<code>BeanDefinitino</code>注册到<code>BeanFactory</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfigurationSelector</span> <span class="keyword">extends</span> <span class="title">AdviceModeImportSelector</span>&lt;<span class="title">EnableAsync</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME =</span><br><span class="line">    <span class="string">&quot;org.springframework.scheduling.aspectj.AspectJAsyncConfiguration&quot;</span>;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">public</span> String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (adviceMode) &#123;</span><br><span class="line">      <span class="keyword">case</span> PROXY:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;ProxyAsyncConfiguration.class.getName()&#125;;</span><br><span class="line">      <span class="keyword">case</span> ASPECTJ:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;ASYNC_EXECUTION_ASPECT_CONFIGURATION_CLASS_NAME&#125;;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


















      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/05/13/Async/" data-id="ckvtb0r4r0000f2f64ypxbmpa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Aop-Async/" rel="tag">Spring Aop Async</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Spring事件监听" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/10/Spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" class="article-date">
  <time datetime="2019-05-10T02:06:19.000Z" itemprop="datePublished">2019-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/10/Spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/">Spring事件监听</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1  背景"></a>1  背景</h2><p>​    在业务开发中，经常是多人协同开发。常有”业务A完成后，需要通知业务B”的场景，最平常的写法就是直接在业务A后面增加业务B的调用。这样的缺点就是业务逻辑耦合，一旦业务C也需要业务A的结果时，就不得不在业务A后面新增调用业务C的代码。</p>
<p>​    针对这种监听事件，第一时间想到的就是”观察者模式”。使用该模式，新增业务C监听的时候，不需要改动业务A的代码。做到了业务代码的解耦。</p>
<p>​    Spring重写了Java自带的事件监听。</p>
<blockquote>
<p><code>org.springframework.context.ApplicationEvent</code> 继承 <code>java.util.EventObject</code></p>
<p><code>org.springframework.context.ApplicationListener</code> 继承 <code>java.util.EventListener</code></p>
</blockquote>
<h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2 使用"></a>2 使用</h2><p>​    springframework 中有许多内建的 <code>ApplicationEvent</code>，这里就不做过多的描述，主要针对自定义事件的使用。</p>
<h3 id="2-1-自定义事件监听"><a href="#2-1-自定义事件监听" class="headerlink" title="2.1 自定义事件监听"></a>2.1 自定义事件监听</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建 Spring 应用上下文 GenericApplicationContext</span></span><br><span class="line">  GenericApplicationContext context = <span class="keyword">new</span> GenericApplicationContext();</span><br><span class="line">  <span class="comment">// 注册 ApplicationListener&lt;MyApplicationEvent&gt; 实现 MyApplicationListener</span></span><br><span class="line">  context.registerBean(MyApplicationListener.class); <span class="comment">// registerBean 方法从 Spring 5 引入</span></span><br><span class="line">  <span class="comment">// 初始化上下文</span></span><br><span class="line">  context.refresh();</span><br><span class="line">  <span class="comment">// 发布自定义事件 MyApplicationEvent</span></span><br><span class="line">  context.publishEvent(<span class="keyword">new</span> MyApplicationEvent(<span class="string">&quot;Hello World&quot;</span>));</span><br><span class="line">  <span class="comment">// 关闭上下文</span></span><br><span class="line">  context.close();</span><br><span class="line">  <span class="comment">// 再次发布事件</span></span><br><span class="line">  context.publishEvent(<span class="keyword">new</span> MyApplicationEvent(<span class="string">&quot;Hello World Again&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyApplicationEvent</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MyApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyApplicationEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(event.getClass().getSimpleName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述是测试Demo，注意：<code>ApplicationListener</code> 必须是 Spring 管理的 Bean，并且监听方法必须是 <code>public</code>。</p>
<p>正式项目中，可以按照如下格式使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">MyApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyApplicationEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(event.getClass().getSimpleName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyApplicationEvent</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationEventService</span></span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">()</span></span>&#123;</span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> MyApplicationEvent(<span class="string">&quot;Hello MyApplicationEvent&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-2-注解实现自定义事件监听"><a href="#2-2-注解实现自定义事件监听" class="headerlink" title="2.2 注解实现自定义事件监听"></a>2.2 注解实现自定义事件监听</h3><p>​    自Spring4.2引入了 <code>org.springframework.context.event.EventListener</code> 注解。使用注解的话，上面中的  <code>MyApplicationListener</code>, 就可以按照如下改写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span></span>&#123;</span><br><span class="line">  <span class="meta">@EventListener(MyApplicationEvent.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(MyApplicationEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(event.getClass().getSimpleName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    并且，<code>@EventListener</code> 还支持继承，可以在抽象类上使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractEventListener</span> </span>&#123;</span><br><span class="line">  <span class="meta">@EventListener(ContextRefreshedEvent.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContextRefreshedEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;AbstractEventListener : &quot;</span> + event.getClass().getSimpleName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventListener</span> <span class="keyword">extends</span> <span class="title">AbstractEventListener</span> </span>&#123;</span><br><span class="line">  <span class="meta">@EventListener(ContextClosedEvent.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onContextClosedEvent</span><span class="params">(ContextClosedEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;MyEventListener : &quot;</span> + event.getClass().getSimpleName());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    同时，<code>@EventListener</code> 还支持多事件监听。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMultiEventsListener</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 无参数监听 &#123;@link ContextRefreshedEvent&#125; 和 &#123;@link ContextClosedEvent&#125; 事件</span></span><br><span class="line">  <span class="meta">@EventListener(&#123;ContextRefreshedEvent.class, ContextClosedEvent.class&#125;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;onEvent&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  单一 &#123;@link ApplicationContextEvent&#125; 参数监听 &#123;@link ContextRefreshedEvent&#125; 和 &#123;@link ContextClosedEvent&#125; 事件</span></span><br><span class="line">  <span class="meta">@EventListener(&#123;ContextRefreshedEvent.class, ContextClosedEvent.class&#125;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationContextEvent</span><span class="params">(ApplicationContextEvent event)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;onApplicationContextEvent : &quot;</span> + event.getClass().getSimpleName());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <code>ApplicationContextEvent</code> 同时是以上两个类的父类。</p>
<h3 id="2-3-泛型事件监听"><a href="#2-3-泛型事件监听" class="headerlink" title="2.3 泛型事件监听"></a>2.3 泛型事件监听</h3><p>​    Spring还提供了针对泛型事件监听。泛型事件，必须实现<code>org.springframework.core.ResolvableTypeProvider</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 泛型事件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 泛型类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericEvent</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> <span class="keyword">implements</span> <span class="title">ResolvableTypeProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GenericEvent</span><span class="params">(T source)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ResolvableType <span class="title">getResolvableType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ResolvableType.forClassWithGenerics(getClass(),</span><br><span class="line">                    ResolvableType.forInstance(getSource()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">super</span>.getSource();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEventListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">GenericEvent</span>&lt;<span class="title">User</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;onUser : &quot;</span> + user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserEvent</span><span class="params">(GenericEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;onUserEvent : &quot;</span> + event.getSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(GenericEvent&lt;User&gt; event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;onApplicationEvent : &quot;</span> + event.getSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建 注解驱动 Spring 应用上下文</span></span><br><span class="line">  AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">  <span class="comment">// 注册 UserEventListener，即实现 ApplicationListener ，也包含 @EventListener 方法</span></span><br><span class="line">  context.register(UserEventListener.class);</span><br><span class="line">  <span class="comment">// 初始化上下文</span></span><br><span class="line">  context.refresh();</span><br><span class="line">  <span class="comment">// 构造泛型事件</span></span><br><span class="line">  GenericEvent&lt;User&gt; event = <span class="keyword">new</span> GenericEvent(<span class="keyword">new</span> User(<span class="string">&quot;用户1&quot;</span>));</span><br><span class="line">  <span class="comment">// 发送泛型事件</span></span><br><span class="line">  context.publishEvent(event);</span><br><span class="line">  <span class="comment">// 发送 User 对象作为事件源</span></span><br><span class="line">  context.publishEvent(<span class="keyword">new</span> User(<span class="string">&quot;用户2&quot;</span>));</span><br><span class="line">  <span class="comment">// 关闭上下文</span></span><br><span class="line">  context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    针对泛型事件，在通知的时候，可以直接传入 泛型对象，也可以构建<code>GenericEvent</code>对象。</p>
<h3 id="2-4-异步事件监听"><a href="#2-4-异步事件监听" class="headerlink" title="2.4 异步事件监听"></a>2.4 异步事件监听</h3><p>使用 <code>@Async</code> 注解可以快速实现异步调用。当然，需要提前使用 <code>@EnableAsync </code>，开启异步功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 需要激活异步，否则 @Async 无效</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAsyncEventListener</span> </span>&#123;</span><br><span class="line">  <span class="meta">@EventListener(ContextRefreshedEvent.class)</span></span><br><span class="line">  <span class="meta">@Async</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">ontextRefreshedEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">    println(<span class="string">&quot; MyAsyncEventListener : &quot;</span> + event.getClass().getSimpleName());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以实现实现 <code>org.springframework.scheduling.annotation.AsyncConfigurer</code>自定义异步调用的线程池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//线程池</span></span><br><span class="line">    ThreadPoolExecutor poolExecutor = ThreadPoolGenerator.newCallerRunSyncQueuePool(<span class="string">&quot;AsyncThreadPool&quot;</span>, <span class="number">20</span>, <span class="number">50</span>);</span><br><span class="line">    <span class="keyword">return</span> poolExecutor;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-分析"><a href="#3-分析" class="headerlink" title="3 分析"></a>3 分析</h2><h3 id="3-1-Spring-事件发布"><a href="#3-1-Spring-事件发布" class="headerlink" title="3.1 Spring 事件发布"></a>3.1 Spring 事件发布</h3><h4 id="3-1-1-ApplicationEventMulticaster-注册-ApplicationListener"><a href="#3-1-1-ApplicationEventMulticaster-注册-ApplicationListener" class="headerlink" title="3.1.1 ApplicationEventMulticaster 注册 ApplicationListener"></a>3.1.1 ApplicationEventMulticaster 注册 ApplicationListener</h4><p>​    在<code>org.springframework.context.ApplicationListener</code>的注释上，<code>ApplicationListener</code>是依赖<code>java.util.EventListener</code>的 Observer 设计模式（观察者模式）。并，关联了<code>org.springframework.context.event.ApplicationEventMulticaster</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application Event 多路广播 </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationEventMulticaster</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addApplicationListenerBean</span><span class="params">(String listenerBeanName)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">removeApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">removeApplicationListenerBean</span><span class="params">(String listenerBeanName)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">removeAllListeners</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(ApplicationEvent event)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从以上接口看，<code>ApplicationEventMulticaster</code>的主要职责是：</p>
<ol>
<li>关联 <code>ApplicationListener</code></li>
<li>广播 <code>ApplicationEvent</code></li>
</ol>
</blockquote>
<p>​    从<code>ApplicationEventMulticaster</code>的实现类来看，只有一个抽象类<code>org.springframework.context.event.AbstractApplicationEventMulticaster</code>和唯一实现类<code>org.springframework.context.event.SimpleApplicationEventMulticaster</code>。</p>
<p>​    在抽象类<code>AbstractApplicationEventMulticaster</code>中，你会发现有两个成员变量<code>defaultRetriever</code>和<code>retrieverCache</code>。<code>org.springframework.context.event.AbstractApplicationEventMulticaster.ListenerCacheKey</code> 和 <code>org.springframework.context.event.AbstractApplicationEventMulticaster.ListenerRetriever</code>都是<code>AbstractApplicationEventMulticaster</code>的内部类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractApplicationEventMulticaster</span></span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">ApplicationEventMulticaster</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ListenerRetriever defaultRetriever = <span class="keyword">new</span> ListenerRetriever(<span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">final</span> Map&lt;ListenerCacheKey, ListenerRetriever&gt; retrieverCache = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">64</span>);</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    内部类<code>ListenerCacheKey</code>包含了两个属性，<code>sourceType</code>和<code>eventType</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerCacheKey</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">ListenerCacheKey</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ResolvableType eventType;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; sourceType;</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    内部类<code>ListenerRetriever</code>包含这<code>ApplicationListener</code>的Set。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerRetriever</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; applicationListenerBeans = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> preFiltered;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这时候，就知道<br><code>AbstractApplicationEventMulticaster#defaultRetriever</code>维护这所有的<code>ApplicationListener</code>;<br><code>AbstractApplicationEventMulticaster#retrieverCache</code> 是以<code>ListenerCacheKey</code>为key，<code>ListenerRetriever</code> 为Value 的 Map。并且 <code>ListenerRetriever</code> 维护着<code>ApplicationListener</code>的Set。</p>
<p>​    就是将<code>defaultRetriever</code>进行分类，存在在<code>retrieverCache</code>中。</p>
<h4 id="3-1-2-AbstractApplicationEventMulticaster-广播事件"><a href="#3-1-2-AbstractApplicationEventMulticaster-广播事件" class="headerlink" title="3.1.2 AbstractApplicationEventMulticaster 广播事件"></a>3.1.2 AbstractApplicationEventMulticaster 广播事件</h4><p>​    <code>ApplicationEventMulticaster#multicastEvent(ApplicationEvent)</code>方法在<code>SimpleApplicationEventMulticaster</code>中被重写了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">  ResolvableType type = (eventType != <span class="keyword">null</span> ? eventType : resolveDefaultEventType(event));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) &#123;</span><br><span class="line">    Executor executor = getTaskExecutor();</span><br><span class="line">    <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">      executor.execute(() -&gt; invokeListener(listener, event));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      invokeListener(listener, event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <code>SimpleApplicationEventMulticaster</code>在广播的时候，会先判断<code>executor</code>是否为空，为空才同步调用。可以通过<code>SimpleApplicationEventMulticaster#setTaskExecutor</code>方法初始化。</p>
<h4 id="3-1-3-ApplicationEventMulticaster-与-ApplicationContext-之间的关系"><a href="#3-1-3-ApplicationEventMulticaster-与-ApplicationContext-之间的关系" class="headerlink" title="3.1.3 ApplicationEventMulticaster 与 ApplicationContext 之间的关系"></a>3.1.3 ApplicationEventMulticaster 与 ApplicationContext 之间的关系</h4><p>​    Spring Framework 官方文档提到开发人员可使用<code>ApplicationEventPublisher</code>发布<code>ApplicationEvent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationEventPublisher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">    publishEvent((Object) event);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    从接口上看，<code>ApplicationEventPublisher</code>貌似和<code>ApplicationEventMulticaster </code>没有什么关联。只有发布的接口，没有关联<code>ApplicationListener</code>的接口。</p>
<p>​    不过<code>ApplicationEventPublisher</code>被<code>ApplicationContext</code>继承，因此，无论哪种<code>ApplicationContext</code>都具备发布<code>ApplicationEvent</code>的能力。</p>
<p>​    要如何得到<code>ApplicationEventPublisher</code>实例？官方文档提示，实现<code>ApplicationEventPublisherAware</code>接口。也可以直接使用<code>@Autowired</code>注解自动导入。</p>
<blockquote>
<p>在 Spring Framework 中，Aware Bean 生命周期回调均有<code>ApplicationContextAwareProcessor</code>处理。</p>
</blockquote>
<p>​    <code>ApplicationEventPublisher</code>被<code>ApplicationContext</code>继承，自动注入的<code>ApplicationEventPublisher</code>实例，就是<code>ApplicationContext</code>实例。<code>AbstractApplicationContext</code>完全实现了<code>ApplicationEventPublisher</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Helper class used in event publishing */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">  Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">&quot;Publishing event in &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + event);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ApplicationEvent applicationEvent;</span><br><span class="line">  <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) &#123;</span><br><span class="line">    applicationEvent = (ApplicationEvent) event;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    applicationEvent = <span class="keyword">new</span> PayloadApplicationEvent&lt;&gt;(<span class="keyword">this</span>, event);</span><br><span class="line">    <span class="keyword">if</span> (eventType == <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventType = ((PayloadApplicationEvent&lt;?&gt;) applicationEvent).getResolvableType();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) &#123;</span><br><span class="line">      ((AbstractApplicationContext) <span class="keyword">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.parent.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ApplicationEventMulticaster <span class="title">getApplicationEventMulticaster</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.applicationEventMulticaster == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;ApplicationEventMulticaster not initialized - &quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;call &#x27;refresh&#x27; before multicasting events via the context: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.applicationEventMulticaster;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <code>applicationEventMulticaster</code>属性由<code>initApplicationEventMulticaster()</code>方法初始化，并且该方法被<code>refresh()</code>调用。</p>
<p>​    因此<code>ConfigurableApplicationContext</code>能够发布事件，管理事件，是复用了<code>ApplicationEventMulticaster</code>。</p>
<blockquote>
<p>总结：</p>
<p><code>ConfigurableApplicationContext</code>继承 <code>ApplicationEventPublisher</code>。</p>
<p><code>ApplicationEventPublisher</code>拥有发布<code>ApplicationEvent</code>的接口。</p>
<p><code>AbstractApplicationContext</code>实现 <code>ConfigurableApplicationContext</code>接口，增加成员变量<code>ApplicationEventMulticaster</code>，利用<code>ApplicationEventMulticaster</code>实现<code>ApplicationEventPublisher</code>的功能。</p>
<p><code>ApplicationEventMulticaster</code>负责管理<code>ApplicationListener</code>。</p>
</blockquote>
<h3 id="3-2-Spring-自定义事件"><a href="#3-2-Spring-自定义事件" class="headerlink" title="3.2 Spring 自定义事件"></a>3.2 Spring 自定义事件</h3><p>​    根据官方文档的提示，自定义 Spring 事件需要扩展<code>ApplicationEvent</code>接口，然后由<code>ApplicationEventPublisher#publishEvent(java.lang.Object)</code>发布即可。</p>
<h3 id="3-3-Spring-事件监听"><a href="#3-3-Spring-事件监听" class="headerlink" title="3.3 Spring 事件监听"></a>3.3 Spring 事件监听</h3><p>​    Spring 事件监听接口 <code>ApplicationListener</code>是事件监听的常见手段。在此基础上，Spring 4.2开始引入<code>@EventListener</code>注解。</p>
<h4 id="3-3-1-ApplicationListener监听原理"><a href="#3-3-1-ApplicationListener监听原理" class="headerlink" title="3.3.1 ApplicationListener监听原理"></a>3.3.1 <code>ApplicationListener</code>监听原理</h4><p>​    根据上面的内容，以知发布事件，调用的是<code>SimpleApplicationEventMulticaster#multicastEvent(ApplicationEvent)</code>。并且<code>SimpleApplicationEventMulticaster</code>可关联<code>Executor</code>实现异步事件广播。然后，SimpleApplicationEventMulticaster默认采用同步广播。根据<code>ApplicationEvent</code>具体类型查找匹配的<code>ApplicationListener</code>列表，然后逐一同步或异步调用<code>ApplicationListener#onApplicationEvent</code>方法，实现<code>ApplicationListener</code>的监听。</p>
<h4 id="3-3-2-EventListener-方法实现原理"><a href="#3-3-2-EventListener-方法实现原理" class="headerlink" title="3.3.2 @EventListener 方法实现原理"></a>3.3.2 <code>@EventListener</code> 方法实现原理</h4><p>​    从 Spring Framework 4.2 开始，框架层面在 <code>AnnotationConfigUtils#registerAnnotationConfigProcessors(BeanDefinitionRegistry, Object)</code>方法中增加了<code>@EventListener</code>方法处理的相关Bean的注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EVENT_LISTENER_PROCESSOR_BEAN_NAME =</span><br><span class="line">  <span class="string">&quot;org.springframework.context.event.internalEventListenerProcessor&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EVENT_LISTENER_FACTORY_BEAN_NAME =</span><br><span class="line">  <span class="string">&quot;org.springframework.context.event.internalEventListenerFactory&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">      RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line">      def.setSource(source);</span><br><span class="line">      beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">    RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line">    def.setSource(source);</span><br><span class="line">    beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其中<code>EventListenerMethodProcessor</code>是<code>@EventListener</code>方法的生命周期处理器，而<code>DefaultEventListenerFactory</code>则是<code>@EventListener</code>方法与<code>ApplicationListener</code>适配器的工程类。</p>
<p>​    <code>EventListenerMethodProcessor</code>作为<code>SmartInitializingSingleton</code>接口实现。</p>
<h5 id="3-3-2-1-SmartInitializingSingleton生命周期回调"><a href="#3-3-2-1-SmartInitializingSingleton生命周期回调" class="headerlink" title="3.3.2.1 SmartInitializingSingleton生命周期回调"></a>3.3.2.1 <code>SmartInitializingSingleton</code>生命周期回调</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmartInitializingSingleton</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    通过调用关系可以发现，<code>SmartInitializingSingleton#afterSingletonsInstantiated()</code>方法将在<code>DefaultListableBeanFactory#preInstantiateSingletons()</code>方法执行时调用。</p>
<p>​    同时，从完整的Spring应用上下文生命周期分析，以上<code>preInstantiateSingletons()</code>方法处于<code>AbstractApplicationContext#finishBeanFactoryInitialization(ConfigurableListableBeanFactory)</code>调用周期的最后一个操作，并且也接近于<code>refresh()</code>方法的完成阶段。</p>
<h5 id="3-3-2-2-EventListenerMethodProcessor的实现原理"><a href="#3-3-2-2-EventListenerMethodProcessor的实现原理" class="headerlink" title="3.3.2.2 EventListenerMethodProcessor的实现原理"></a>3.3.2.2 <code>EventListenerMethodProcessor</code>的实现原理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  List&lt;EventListenerFactory&gt; factories = getEventListenerFactories();</span><br><span class="line">  ConfigurableApplicationContext context = getApplicationContext();</span><br><span class="line">  String[] beanNames = context.getBeanNamesForType(Object.class);</span><br><span class="line">  <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">    ......</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        processBean(factories, beanName, type);</span><br><span class="line">      &#125;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;EventListenerFactory&gt; <span class="title">getEventListenerFactories</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Map&lt;String, EventListenerFactory&gt; beans = getApplicationContext().getBeansOfType(EventListenerFactory.class);</span><br><span class="line">  List&lt;EventListenerFactory&gt; factories = <span class="keyword">new</span> ArrayList&lt;&gt;(beans.values());</span><br><span class="line">  AnnotationAwareOrderComparator.sort(factories);</span><br><span class="line">  <span class="keyword">return</span> factories;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    按照 <code>afterSingletonsInstantiated()</code>方法的生命周期，<code>getEventListenerFactories()</code>方法根据类型在Spring应用上下文中查找所有<code>EventListenerFactory</code> Bean的操作不会引起过早初始化的问题。</p>
<p>​    <code>EventListenerMethodProcessor#processBean</code>方法相对简单，首先从指定Bean类型中超找所有标注<code>@EventListener</code>的方法，由于<code>AnnotatedElementUtils#findMergedAnnotation</code>语言的作用，所有方法筛选的规则是仅判断Bean中所有public方法是否标注<code>@EventListener</code>。</p>
<p>​    然后，<code>EventListenerMethodProcessor</code>将候选的<code>@EventListener</code>方法集合逐一经过<code>EventListenerFactory</code>实例列表（首参）的匹配。而默认情况下，<code>EventListenerFactory</code>实例列表仅为<code>DefaultEventListenerFactory</code>对象，故将<code>@EventListener</code>方法适配为<code>ApplicationListener</code>对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEventListenerFactory</span> <span class="keyword">implements</span> <span class="title">EventListenerFactory</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> ApplicationListener&lt;?&gt; createApplicationListener(String beanName, Class&lt;?&gt; type, Method method) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ApplicationListenerMethodAdapter(beanName, type, method);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    因此，<code>@EventListener</code>方法实现的确与<code>ApplicationListener</code>有关。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/05/10/Spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/" data-id="ckvtb0r4z0003f2f60os7dawb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Event-Listener/" rel="tag">Spring Event Listener</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/09/hello-world/" class="article-date">
  <time datetime="2019-05-09T11:14:41.704Z" itemprop="datePublished">2019-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/09/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://adeng-wc.github.io/2019/05/09/hello-world/" data-id="ckvtb0r560008f2f69uyhdcqn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Resource/" rel="tag">Java Resource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Aop-Async/" rel="tag">Spring Aop Async</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Event-Listener/" rel="tag">Spring Event Listener</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WxJava-%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">WxJava 公众号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WxJava-%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">WxJava 小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%B8%89/" rel="tag">diary 星期三</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%BA%8C/" rel="tag">diary 星期二</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diary-%E6%98%9F%E6%9C%9F%E5%9B%9B/" rel="tag">diary 星期四</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%81%E6%AF%94%E7%89%B9%E5%B8%81/" rel="tag">区块链、比特币</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java-Resource/" style="font-size: 10px;">Java Resource</a> <a href="/tags/Spring-Aop-Async/" style="font-size: 10px;">Spring Aop Async</a> <a href="/tags/Spring-Event-Listener/" style="font-size: 10px;">Spring Event Listener</a> <a href="/tags/WxJava-%E5%85%AC%E4%BC%97%E5%8F%B7/" style="font-size: 10px;">WxJava 公众号</a> <a href="/tags/WxJava-%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 10px;">WxJava 小程序</a> <a href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%B8%89/" style="font-size: 10px;">diary 星期三</a> <a href="/tags/diary-%E6%98%9F%E6%9C%9F%E4%BA%8C/" style="font-size: 10px;">diary 星期二</a> <a href="/tags/diary-%E6%98%9F%E6%9C%9F%E5%9B%9B/" style="font-size: 10px;">diary 星期四</a> <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%81%E6%AF%94%E7%89%B9%E5%B8%81/" style="font-size: 10px;">区块链、比特币</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/24/%E7%90%86%E8%A7%A3%E6%AF%94%E7%89%B9%E5%B8%81/">理解比特币</a>
          </li>
        
          <li>
            <a href="/2019/08/30/diary-20190829/">diary-20190829</a>
          </li>
        
          <li>
            <a href="/2019/08/28/diary-20190828/">diary-20190828</a>
          </li>
        
          <li>
            <a href="/2019/08/27/diary-20190827/">diary-20190827</a>
          </li>
        
          <li>
            <a href="/2019/06/03/%E4%BD%BF%E7%94%A8WxJava%E5%BC%80%E5%8F%91%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/">使用WxJava开发微信公众号</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Weng Cheng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>